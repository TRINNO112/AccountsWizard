<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AccountsWizard 2.0</title>
  <style>
    :root {
      --bg: #0b1020;
      --bg-2: #0f1733;
      --card: #141b38;
      --text: #f7f9ff;
      --muted: #b8c2ff;
      --brand: #7c4dff;
      --brand-2: #00e5ff;
      --accent: #ff7ac6;
      --success: #10b981;
      --warning: #fbbf24;
      --error: #ef4444;
      --radius: 16px;
      --shadow: 0 15px 30px rgba(0,0,0,.35);
    }

    * { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: ui-sans-serif, system-ui, -apple-system;
      background: radial-gradient(1200px 800px at 80% -10%, rgba(124,77,255,.25), transparent 60%),
                  radial-gradient(1000px 700px at 10% 10%, rgba(0,229,255,.15), transparent 55%),
                  linear-gradient(180deg, var(--bg), var(--bg-2));
      color: var(--text);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
    }

    /* Floating Orbs */
    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.3;
      animation: float 20s infinite ease-in-out;
      z-index: -1;
    }

    .orb-1 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, var(--brand), transparent);
      top: -200px;
      right: -200px;
    }

    .orb-2 {
      width: 500px;
      height: 500px;
      background: radial-gradient(circle, var(--accent), transparent);
      bottom: -250px;
      left: -250px;
      animation-delay: 7s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(50px, -50px) scale(1.1); }
      66% { transform: translate(-50px, 50px) scale(0.9); }
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: slideDown 0.6s ease-out;
    }

    @keyframes slideDown {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .header h1 {
      font-size: clamp(2rem, 5vw, 3rem);
      background: linear-gradient(135deg, var(--brand), var(--brand-2), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% auto;
      animation: shimmer 3s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes shimmer {
      to { background-position: 200% center; }
    }

    .header p {
      color: var(--muted);
      font-size: 1.1rem;
    }

    /* Navigation */
    .nav-bar {
      background: rgba(20, 27, 56, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: var(--radius);
      padding: 16px 24px;
      margin-bottom: 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
      max-width: 1600px;
      margin-left: auto;
      margin-right: auto;
      margin-bottom: 32px;
    }

    .nav-bar a {
      color: var(--muted);
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .nav-bar a:hover {
      color: var(--text);
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
      max-width: 1600px;
      margin-left: auto;
      margin-right: auto;
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(124,77,255,0.08), rgba(0,229,255,0.08));
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,229,255,0.2);
      border-color: var(--brand-2);
    }

    .stat-card h3 {
      margin: 0 0 12px 0;
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      font-weight: 600;
    }

    .stat-card .value {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1;
    }

    .stat-card .label {
      margin-top: 8px;
      font-size: 0.75rem;
      color: var(--muted);
      opacity: 0.7;
    }

    /* Users Container */
    .users-container {
      max-width: 1600px;
      margin: 0 auto;
    }

    .user-card {
      background: linear-gradient(135deg, rgba(20, 27, 56, 0.9), rgba(15, 23, 51, 0.9));
      backdrop-filter: blur(20px);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 32px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .user-card:hover {
      transform: translateY(-4px);
      border-color: var(--brand-2);
      box-shadow: 0 25px 50px rgba(0,229,255,0.15);
    }

    .user-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 2px solid rgba(255,255,255,0.05);
    }

    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--brand);
      box-shadow: 0 8px 20px rgba(124,77,255,0.3);
    }

    .user-info {
      flex: 1;
    }

    .user-info h3 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      background: linear-gradient(135deg, var(--text), var(--brand-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .user-info p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
    }

    .user-stats {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .user-stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .user-stat-item strong {
      color: var(--brand-2);
      font-weight: 700;
    }

    /* Tab Navigation */
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      border-bottom: 2px solid rgba(255,255,255,0.05);
      padding-bottom: 12px;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .tab-btn:hover {
      background: rgba(255,255,255,0.08);
      border-color: var(--brand-2);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 15px rgba(124,77,255,0.3);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Lesson Details */
    .lesson-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .lesson-card {
      background: rgba(255,255,255,0.03);
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid var(--success);
      transition: all 0.3s ease;
    }

    .lesson-card:hover {
      background: rgba(255,255,255,0.06);
      transform: translateX(6px);
    }

    .lesson-card h4 {
      margin: 0 0 12px 0;
      color: var(--brand-2);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .lesson-meta {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 0.9rem;
    }

    .lesson-meta span {
      color: var(--muted);
    }

    .lesson-meta strong {
      color: var(--text);
      font-weight: 700;
    }

    .percentage-badge {
      display: inline-block;
      padding: 6px 12px;
      background: linear-gradient(135deg, var(--success), #34d399);
      color: white;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 700;
      margin-top: 8px;
    }

    .percentage-badge.medium {
      background: linear-gradient(135deg, var(--warning), #fbbf24);
    }

    .percentage-badge.low {
      background: linear-gradient(135deg, var(--error), #f87171);
    }

    /* Quiz Details */
    .quiz-attempt-card {
      background: rgba(255,255,255,0.03);
      padding: 24px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }

    .quiz-attempt-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      flex-wrap: wrap;
      gap: 12px;
    }

    .quiz-attempt-header h4 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--brand-2);
    }

    .quiz-stats-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .quiz-stat-box {
      background: rgba(255,255,255,0.03);
      padding: 12px 20px;
      border-radius: 8px;
      border-left: 3px solid var(--brand-2);
    }

    .quiz-stat-box .label {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .quiz-stat-box .value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
    }

    /* Question Breakdown */
    .questions-list {
      display: grid;
      gap: 12px;
    }

    .question-item {
      background: rgba(255,255,255,0.02);
      padding: 16px;
      border-radius: 10px;
      border-left: 4px solid var(--success);
      transition: all 0.2s ease;
    }

    .question-item:hover {
      background: rgba(255,255,255,0.05);
      transform: translateX(4px);
    }

    .question-item.wrong {
      border-left-color: var(--error);
    }

    .question-item.skipped {
      border-left-color: var(--warning);
    }

    .question-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      gap: 12px;
    }

    .question-number {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      white-space: nowrap;
    }

    .question-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .badge.chapter {
      background: rgba(124,77,255,0.2);
      color: var(--brand-2);
      border: 1px solid var(--brand-2);
    }

    .badge.difficulty {
      background: rgba(251,191,36,0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .badge.correct {
      background: rgba(16,185,129,0.2);
      color: var(--success);
      border: 1px solid var(--success);
    }

    .badge.wrong {
      background: rgba(239,68,68,0.2);
      color: var(--error);
      border: 1px solid var(--error);
    }

    .badge.skipped {
      background: rgba(251,191,36,0.2);
      color: var(--warning);
      border: 1px solid var(--warning);
    }

    .question-text {
      color: var(--text);
      font-size: 0.95rem;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .answer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
      flex-wrap: wrap;
      gap: 8px;
    }

    .answer-row span {
      color: var(--muted);
    }

    .answer-row strong {
      color: var(--text);
    }

    /* Toggle Details Button */
    .toggle-details {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--brand-2);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 16px;
    }

    .toggle-details:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--brand-2);
    }

    .question-details {
      display: none;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    .question-details.show {
      display: block;
    }

    .question-details .detail-row {
      display: flex;
      gap: 12px;
      margin: 8px 0;
      font-size: 0.85rem;
    }

    .question-details .detail-row .label {
      color: var(--muted);
      min-width: 120px;
    }

    .question-details .detail-row .value {
      color: var(--text);
      flex: 1;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 80px 20px;
      font-size: 1.2rem;
      color: var(--muted);
    }

    .spinner {
      width: 60px;
      height: 60px;
      border: 5px solid rgba(255,255,255,0.1);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Search Bar */
    .search-bar {
      max-width: 1600px;
      margin: 0 auto 24px;
      position: relative;
    }

    .search-bar input {
      width: 100%;
      padding: 16px 20px 16px 50px;
      background: rgba(20,27,56,0.8);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    .search-bar input:focus {
      outline: none;
      border-color: var(--brand-2);
      box-shadow: 0 0 0 4px rgba(0,229,255,0.1);
    }

    .search-bar::before {
      content: 'üîç';
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body { padding: 12px; }
      .header h1 { font-size: 1.8rem; }
      .stats-grid { grid-template-columns: 1fr 1fr; gap: 12px; }
      .user-header { flex-direction: column; text-align: center; }
      .nav-bar { flex-direction: column; gap: 12px; }
      .lesson-grid { grid-template-columns: 1fr; }
      .quiz-attempt-header { flex-direction: column; align-items: flex-start; }
    }

    /* No Data */
    .no-data {
      text-align: center;
      padding: 80px 20px;
      color: var(--muted);
    }

    .no-data h2 {
      font-size: 2rem;
      margin-bottom: 16px;
      background: linear-gradient(135deg, var(--warning), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
  </style>
</head>
<body>
  <!-- Background Orbs -->
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <!-- Navigation -->
  <div class="nav-bar">
    <a href="index.html">üè† Home</a>
    <a href="lessons.html">üìö Lessons</a>
    <a href="quiz.html">üéØ Quiz</a>
    <a href="#" onclick="location.reload()">üîÑ Refresh</a>
  </div>

  <!-- Header -->
  <div class="header">
    <h1>üìä Admin Dashboard 2.0</h1>
    <p>Complete User Analytics with Question-Level Details</p>
  </div>

  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total Users</h3>
      <div class="value" id="totalUsers">0</div>
      <div class="label">Active learners</div>
    </div>
    <div class="stat-card">
      <h3>Lessons Completed</h3>
      <div class="value" id="totalLessons">0</div>
      <div class="label">Total attempts</div>
    </div>
    <div class="stat-card">
      <h3>Quizzes Taken</h3>
      <div class="value" id="totalQuizzes">0</div>
      <div class="label">Total attempts</div>
    </div>
    <div class="stat-card">
      <h3>Questions Answered</h3>
      <div class="value" id="totalQuestions">0</div>
      <div class="label">Across platform</div>
    </div>
    <div class="stat-card">
      <h3>Avg Lesson Score</h3>
      <div class="value" id="avgLessons">0%</div>
      <div class="label">Average completion</div>
    </div>
    <div class="stat-card">
      <h3>Avg Quiz Score</h3>
      <div class="value" id="avgQuiz">0%</div>
      <div class="label">Average performance</div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search by name or email..." onkeyup="filterUsers()">
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="loading">
    <div class="spinner"></div>
    <p>Loading comprehensive user data...</p>
    <p style="font-size: 0.9rem; margin-top: 12px; color: var(--muted);">
      Fetching lessons, quizzes, and question details
    </p>
  </div>

  <!-- Users Container -->
  <div id="usersContainer" class="users-container" style="display: none;"></div>

  <script type="module">
    // ============================================
    // FIREBASE IMPORTS
    // ============================================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      getDocs,
      doc,
      getDoc,
      query,
      where
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAsVXny76jcd7XeAkErqdBW7l89B5T5nws",
      authDomain: "accountswizard-2025.firebaseapp.com",
      projectId: "accountswizard-2025",
      storageBucket: "accountswizard-2025.firebasestorage.app",
      messagingSenderId: "678121384731",
      appId: "1:678121384731:web:6c1cea60976976966f81be",
      measurementId: "G-YLYVNGL5T7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let allUsersData = [];

    // ============================================
    // LOAD COMPLETE USER DATA
    // ============================================
    async function loadDashboard() {
      console.log('üîÑ Loading dashboard...');
      
      try {
        const usersData = [];
        
        // Get all users from overall-progress
        const progressSnapshot = await getDocs(collection(db, 'overall-progress'));
        
        if (progressSnapshot.empty) {
          showNoData();
          return;
        }
        
        for (const progressDoc of progressSnapshot.docs) {
          const progressData = progressDoc.data();
          const userId = progressData.userId;
          
          // Get user profile
          const userRef = doc(db, 'users', userId);
          const userSnap = await getDoc(userRef);
          const userData = userSnap.exists() ? userSnap.data() : {};
          
          // Get ALL lesson attempts for this user
          const lessonsQuery = query(
            collection(db, 'user-progress'),
            where('userId', '==', userId),
            where('type', '==', 'lesson')
          );
          const lessonsSnapshot = await getDocs(lessonsQuery);
          const lessonAttempts = [];
          lessonsSnapshot.forEach(doc => {
            lessonAttempts.push(doc.data());
          });
          
          // Get ALL quiz attempts for this user
          const quizzesQuery = query(
            collection(db, 'quiz-progress'),
            where('userId', '==', userId),
            where('type', '==', 'quiz')
          );
          const quizzesSnapshot = await getDocs(quizzesQuery);
          const quizAttempts = [];
          quizzesSnapshot.forEach(doc => {
            quizAttempts.push(doc.data());
          });
          
          usersData.push({
            userId: userId,
            name: userData.name || userData.displayName || 'Anonymous User',
            email: userData.email || 'No email',
            photoURL: userData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'User')}&background=7c4dff&color=fff&size=128`,
            progress: progressData,
            lessons: lessonAttempts,
            quizzes: quizAttempts,
            lastLogin: userData.lastLogin || null
          });
        }
        
        console.log(`‚úÖ Loaded ${usersData.length} users with full details`);
        
        allUsersData = usersData;
        document.getElementById('loadingState').style.display = 'none';
        renderDashboard(usersData);
        
      } catch (error) {
        console.error('‚ùå Error:', error);
        showError(error);
      }
    }

    // ============================================
    // RENDER DASHBOARD
    // ============================================
    function renderDashboard(users) {
      if (users.length === 0) {
        showNoData();
        return;
      }

      // Calculate global statistics
      let totalLessons = 0;
      let totalQuizzes = 0;
      let totalQuestions = 0;
      let totalLessonScore = 0;
      let totalLessonTotal = 0;
      let totalQuizScore = 0;
      let totalQuizTotal = 0;

      users.forEach(user => {
        totalLessons += user.lessons.length;
        totalQuizzes += user.quizzes.length;
        
        user.lessons.forEach(lesson => {
          totalQuestions += lesson.totalQuestions || 0;
          totalLessonScore += lesson.score || 0;
          totalLessonTotal += lesson.totalQuestions || 0;
        });
        
        user.quizzes.forEach(quiz => {
          const qCount = quiz.totalQuestions || 0;
          totalQuestions += qCount;
          totalQuizScore += quiz.score || 0;
          totalQuizTotal += qCount;
        });
      });

      // Update stats with animation
      animateValue('totalUsers', 0, users.length, 1000);
      animateValue('totalLessons', 0, totalLessons, 1000);
      animateValue('totalQuizzes', 0, totalQuizzes, 1000);
      animateValue('totalQuestions', 0, totalQuestions, 1000);
      animateValue('avgLessons', 0, totalLessonTotal > 0 ? Math.round((totalLessonScore/totalLessonTotal)*100) : 0, 1000, '%');
      animateValue('avgQuiz', 0, totalQuizTotal > 0 ? Math.round((totalQuizScore/totalQuizTotal)*100) : 0, 1000, '%');

      // Render each user
      const container = document.getElementById('usersContainer');
      container.innerHTML = users.map((user, userIndex) => {
        const overallPercent = user.progress?.overall?.percentage || 0;
        
        return `
          <div class="user-card" data-name="${user.name.toLowerCase()}" data-email="${user.email.toLowerCase()}">
            <!-- User Header -->
            <div class="user-header">
              <img src="${user.photoURL}" alt="${user.name}" class="user-avatar" 
                   onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=7c4dff&color=fff&size=128'">
              <div class="user-info">
                <h3>${user.name}</h3>
                <p>${user.email}</p>
                <div class="user-stats">
                  <div class="user-stat-item">
                    üìö <strong>${user.lessons.length}</strong> Lessons
                  </div>
                  <div class="user-stat-item">
                    üéØ <strong>${user.quizzes.length}</strong> Quizzes
                  </div>
                  <div class="user-stat-item">
                    üèÜ <strong>${overallPercent}%</strong> Overall
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
              <button class="tab-btn active" onclick="switchTab(${userIndex}, 'overview')">
                üìä Overview
              </button>
              <button class="tab-btn" onclick="switchTab(${userIndex}, 'lessons')">
                üìö Lessons (${user.lessons.length})
              </button>
              <button class="tab-btn" onclick="switchTab(${userIndex}, 'quizzes')">
                üéØ Quizzes (${user.quizzes.length})
              </button>
            </div>

            <!-- Tab Contents -->
            <div id="tab-overview-${userIndex}" class="tab-content active">
              ${renderOverview(user)}
            </div>

            <div id="tab-lessons-${userIndex}" class="tab-content">
              ${renderLessons(user)}
            </div>

            <div id="tab-quizzes-${userIndex}" class="tab-content">
              ${renderQuizzes(user)}
            </div>
          </div>
        `;
      }).join('');

      container.style.display = 'block';
    }

    // ============================================
    // RENDER OVERVIEW TAB
    // ============================================
    function renderOverview(user) {
      const lessonsPercent = user.progress?.lessons?.percentage || 0;
      const quizzesPercent = user.progress?.quizzes?.percentage || 0;
      const overallPercent = user.progress?.overall?.percentage || 0;

      return `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
          <!-- Lessons Summary -->
          <div style="background: rgba(16,185,129,0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--success);">
            <h4 style="margin: 0 0 16px 0; color: var(--success);">üìö Lessons Progress</h4>
            <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem;">
              <span style="color: var(--muted);">Completed</span>
              <strong style="color: var(--text);">${user.progress?.lessons?.completed || 0} / 14</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem;">
              <span style="color: var(--muted);">Score</span>
              <strong style="color: var(--text);">${user.progress?.lessons?.score || 0} / ${user.progress?.lessons?.total || 0}</strong>
            </div>
            <div class="percentage-badge" style="width: 100%; text-align: center; margin-top: 12px;">
              ${lessonsPercent}%
            </div>
          </div>

          <!-- Quizzes Summary -->
          <div style="background: rgba(0,229,255,0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--brand-2);">
            <h4 style="margin: 0 0 16px 0; color: var(--brand-2);">üéØ Quiz Progress</h4>
            <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem;">
              <span style="color: var(--muted);">Attempts</span>
              <strong style="color: var(--text);">${user.quizzes.length}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem;">
              <span style="color: var(--muted);">Score</span>
              <strong style="color: var(--text);">${user.progress?.quizzes?.score || 0} / ${user.progress?.quizzes?.total || 0}</strong>
            </div>
            <div class="percentage-badge" style="width: 100%; text-align: center; margin-top: 12px;">
              ${quizzesPercent}%
            </div>
          </div>

          <!-- Overall Summary -->
          <div style="background: rgba(255,122,198,0.1); padding: 20px; border-radius: 12px; border-left: 4px solid var(--accent);">
            <h4 style="margin: 0 0 16px 0; color: var(--accent);">üèÜ Overall Progress</h4>
            <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem;">
              <span style="color: var(--muted);">Total Score</span>
              <strong style="color: var(--text);">${user.progress?.overall?.score || 0} / ${user.progress?.overall?.total || 0}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.9rem;">
              <span style="color: var(--muted);">Completion</span>
              <strong style="color: var(--text);">${overallPercent}%</strong>
            </div>
            <div class="percentage-badge" style="width: 100%; text-align: center; margin-top: 12px;">
              ${overallPercent}%
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // RENDER LESSONS TAB
    // ============================================
    function renderLessons(user) {
      if (user.lessons.length === 0) {
        return `
          <div class="no-data">
            <h2>üìö No Lessons Completed Yet</h2>
            <p>This user hasn't completed any lessons.</p>
          </div>
        `;
      }

      // Sort by lesson number
      const sortedLessons = [...user.lessons].sort((a, b) => 
        (a.lessonNumber || 0) - (b.lessonNumber || 0)
      );

      return `
        <div class="lesson-grid">
          ${sortedLessons.map(lesson => {
            const percentage = lesson.percentage || 0;
            const badgeClass = percentage >= 80 ? '' : percentage >= 60 ? 'medium' : 'low';
            
            return `
              <div class="lesson-card">
                <h4>üìñ Lesson ${lesson.lessonNumber || 'N/A'}</h4>
                <div class="lesson-meta">
                  <span>Score</span>
                  <strong>${lesson.score} / ${lesson.totalQuestions}</strong>
                </div>
                <div class="lesson-meta">
                  <span>Attempts</span>
                  <strong>${lesson.attempts || 1}</strong>
                </div>
                <div class="percentage-badge ${badgeClass}">
                  ${percentage}%
                </div>
                
                ${lesson.answers && lesson.answers.length > 0 ? `
                  <button class="toggle-details" onclick="toggleDetails(this)">
                    View Question Details
                  </button>
                  <div class="question-details">
                    <h5 style="margin: 0 0 12px 0; color: var(--brand-2);">Question Breakdown:</h5>
                    ${lesson.answers.map((answer, idx) => `
                      <div style="padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: var(--muted); font-size: 0.85rem;">Q${idx + 1}</span>
                          <span class="badge ${answer.isCorrect ? 'correct' : 'wrong'}">
                            ${answer.isCorrect ? '‚úì Correct' : '‚úó Wrong'}
                          </span>
                        </div>
                        ${answer.question ? `
                          <div style="color: var(--text); font-size: 0.85rem; margin-top: 4px;">
                            ${answer.question}
                          </div>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ============================================
    // RENDER QUIZZES TAB
    // ============================================
    function renderQuizzes(user) {
      if (user.quizzes.length === 0) {
        return `
          <div class="no-data">
            <h2>üéØ No Quizzes Taken Yet</h2>
            <p>This user hasn't taken any quizzes.</p>
          </div>
        `;
      }

      return user.quizzes.map((quiz, quizIdx) => {
        const percentage = quiz.percentage || 0;
        const chapters = quiz.chapterIds || [];
        
        return `
          <div class="quiz-attempt-card">
            <!-- Quiz Header -->
            <div class="quiz-attempt-header">
              <div>
                <h4>Quiz Attempt #${quizIdx + 1}</h4>
                <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                  ${chapters.map(ch => `
                    <span class="badge chapter">Chapter ${ch}</span>
                  `).join('')}
                </div>
              </div>
              <div class="percentage-badge ${percentage >= 80 ? '' : percentage >= 60 ? 'medium' : 'low'}">
                ${percentage}%
              </div>
            </div>

            <!-- Quiz Stats -->
            <div class="quiz-stats-row">
              <div class="quiz-stat-box">
                <div class="label">Score</div>
                <div class="value">${quiz.score} / ${quiz.totalQuestions}</div>
              </div>
              <div class="quiz-stat-box" style="border-left-color: var(--success);">
                <div class="label">Correct</div>
                <div class="value" style="color: var(--success);">${quiz.correctCount || quiz.score}</div>
              </div>
              <div class="quiz-stat-box" style="border-left-color: var(--error);">
                <div class="label">Wrong</div>
                <div class="value" style="color: var(--error);">${quiz.wrongCount || 0}</div>
              </div>
              <div class="quiz-stat-box" style="border-left-color: var(--warning);">
                <div class="label">Skipped</div>
                <div class="value" style="color: var(--warning);">${quiz.skippedCount || 0}</div>
              </div>
              <div class="quiz-stat-box" style="border-left-color: var(--brand);">
                <div class="label">Time Spent</div>
                <div class="value">${formatTime(quiz.totalTimeSpent || 0)}</div>
              </div>
              <div class="quiz-stat-box" style="border-left-color: var(--accent);">
                <div class="label">Avg Time/Q</div>
                <div class="value">${quiz.averageTimePerQuestion || 0}s</div>
              </div>
            </div>

            <!-- Question Breakdown -->
            ${quiz.answers && quiz.answers.length > 0 ? `
              <div style="margin-top: 24px;">
                <h5 style="margin: 0 0 16px 0; color: var(--brand-2); font-size: 1.1rem;">
                  üìã Question-by-Question Breakdown
                </h5>
                <div class="questions-list">
                  ${quiz.answers.map((q, idx) => {
                    const isCorrect = q.isCorrect;
                    const isSkipped = q.isSkipped;
                    const statusClass = isSkipped ? 'skipped' : isCorrect ? 'correct' : 'wrong';
                    const statusBadge = isSkipped ? 'skipped' : isCorrect ? 'correct' : 'wrong';
                    const statusText = isSkipped ? '‚äò Skipped' : isCorrect ? '‚úì Correct' : '‚úó Wrong';
                    
                    return `
                      <div class="question-item ${statusClass}">
                        <div class="question-header-row">
                          <span class="question-number">Q${q.questionNumber || idx + 1}</span>
                          <div class="question-badges">
                            <span class="badge chapter">Ch ${q.chapter || 'N/A'}</span>
                            <span class="badge difficulty">${q.difficulty || 'medium'}</span>
                            <span class="badge ${statusBadge}">${statusText}</span>
                          </div>
                        </div>
                        
                        <div class="question-text">
                          ${q.question || 'Question text not available'}
                        </div>

                        <div class="answer-row">
                          <div>
                            <span>Type:</span> 
                            <strong>${q.type === 'single' ? 'Single Choice' : 'Multiple Choice'}</strong>
                          </div>
                          ${q.timeSpent ? `
                            <div>
                              <span>Time:</span> 
                              <strong>${q.timeSpent}s</strong>
                            </div>
                          ` : ''}
                          ${q.hintsUsed ? `
                            <div>
                              <span>Hints:</span> 
                              <strong>${q.hintsUsed}</strong>
                            </div>
                          ` : ''}
                        </div>

                        <button class="toggle-details" onclick="toggleDetails(this)">
                          Show Full Details
                        </button>

                        <div class="question-details">
                          <div class="detail-row">
                            <span class="label">Chapter Title:</span>
                            <span class="value">${q.chapterTitle || 'Unknown'}</span>
                          </div>
                          <div class="detail-row">
                            <span class="label">User Answer:</span>
                            <span class="value">${formatAnswer(q.userAnswer, q.options)}</span>
                          </div>
                          <div class="detail-row">
                            <span class="label">Correct Answer:</span>
                            <span class="value" style="color: var(--success);">${formatAnswer(q.correctAnswer, q.options)}</span>
                          </div>
                          ${q.explanation ? `
                            <div class="detail-row">
                              <span class="label">Explanation:</span>
                              <span class="value">${q.explanation}</span>
                            </div>
                          ` : ''}
                          ${q.options && q.options.length > 0 ? `
                            <div style="margin-top: 12px;">
                              <div class="label" style="margin-bottom: 8px;">All Options:</div>
                              ${q.options.map((opt, optIdx) => `
                                <div style="padding: 6px 0; font-size: 0.85rem; color: var(--muted);">
                                  ${optIdx + 1}. ${opt}
                                </div>
                              `).join('')}
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : '<p style="color: var(--muted); text-align: center; padding: 20px;">No question details available</p>'}
          </div>
        `;
      }).join('');
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
    }

    function formatAnswer(answer, options) {
      if (answer === 'skipped') return '‚äò Skipped';
      if (answer === null || answer === undefined || answer === -1) return 'No answer';
      
      if (Array.isArray(answer)) {
        if (answer.length === 0) return 'No answer';
        return answer.map(idx => 
          options && options[idx] ? `${idx + 1}. ${options[idx]}` : `Option ${idx + 1}`
        ).join(', ');
      }
      
      return options && options[answer] ? `${answer + 1}. ${options[answer]}` : `Option ${answer + 1}`;
    }

    function animateValue(id, start, end, duration, suffix = '') {
      const element = document.getElementById(id);
      if (!element) return;
      
      const range = end - start;
      const increment = range / (duration / 16);
      let current = start;
      
      const timer = setInterval(() => {
        current += increment;
        if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
          current = end;
          clearInterval(timer);
        }
        element.textContent = Math.round(current) + suffix;
      }, 16);
    }

    function showNoData() {
      document.getElementById('loadingState').innerHTML = `
        <div class="no-data">
          <h2>üî≠ No Users Found</h2>
          <p>No one has started using the platform yet.</p>
        </div>
      `;
    }

    function showError(error) {
      document.getElementById('loadingState').innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: var(--error);">
          <h2>‚ö†Ô∏è Error Loading Data</h2>
          <p>${error.message}</p>
          <button onclick="location.reload()" style="
            margin-top: 20px;
            padding: 12px 24px;
            background: var(--brand);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
          ">Try Again</button>
        </div>
      `;
    }

    // ============================================
    // GLOBAL FUNCTIONS (for onclick)
    // ============================================
    window.switchTab = function(userIndex, tabName) {
      // Hide all tabs for this user
      ['overview', 'lessons', 'quizzes'].forEach(tab => {
        const content = document.getElementById(`tab-${tab}-${userIndex}`);
        const btn = document.querySelectorAll(`.user-card`)[userIndex].querySelectorAll('.tab-btn')[
          tab === 'overview' ? 0 : tab === 'lessons' ? 1 : 2
        ];
        
        if (content) content.classList.remove('active');
        if (btn) btn.classList.remove('active');
      });
      
      // Show selected tab
      const selectedContent = document.getElementById(`tab-${tabName}-${userIndex}`);
      const selectedBtn = document.querySelectorAll(`.user-card`)[userIndex].querySelectorAll('.tab-btn')[
        tabName === 'overview' ? 0 : tabName === 'lessons' ? 1 : 2
      ];
      
      if (selectedContent) selectedContent.classList.add('active');
      if (selectedBtn) selectedBtn.classList.add('active');
    };

    window.toggleDetails = function(button) {
      const details = button.nextElementSibling;
      if (details && details.classList.contains('question-details')) {
        details.classList.toggle('show');
        button.textContent = details.classList.contains('show') ? 
          'Hide Details' : button.textContent.includes('Question') ? 'View Question Details' : 'Show Full Details';
      }
    };

    window.filterUsers = function() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const userCards = document.querySelectorAll('.user-card');
      
      userCards.forEach(card => {
        const name = card.dataset.name;
        const email = card.dataset.email;
        
        if (name.includes(searchTerm) || email.includes(searchTerm)) {
          card.style.display = 'block';
        } else {
          card.style.display = 'none';
        }
      });
    };

    // ============================================
    // START DASHBOARD
    // ============================================
    loadDashboard();
  </script>
</body>
</html>