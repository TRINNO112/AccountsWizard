<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="../favicon/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="../favicon/favicon.svg" />
  <link rel="shortcut icon" href="../favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="../favicon/apple-touch-icon.png" />
  <link rel="manifest" href="../favicon/site.webmanifest" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depreciation Practice - Grade 11 Accountancy</title>
    <style>
        /* ========== CSS RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-color: #00d26a;
            --error-color: #ff4757;
            --warning-color: #ffa502;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.08);
            --input-focus: rgba(102, 126, 234, 0.3);
            --table-header: #2d3a4f;
            --table-row-odd: rgba(255, 255, 255, 0.02);
            --table-row-even: rgba(255, 255, 255, 0.05);
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.2);
            --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.3);
            --shadow-heavy: 0 15px 50px rgba(0, 0, 0, 0.4);
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 20px;
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ========== ANIMATED BACKGROUND ========== */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .background-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 50%);
            animation: rotateBackground 30s linear infinite;
        }

        .background-animation::after {
            content: '';
            position: absolute;
            bottom: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            animation: rotateBackground 25s linear infinite reverse;
        }

        @keyframes rotateBackground {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Floating particles */
        .particle {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            animation: floatParticle 15s infinite ease-in-out;
        }

        @keyframes floatParticle {
            0%, 100% { transform: translateY(0) translateX(0); opacity: 0.3; }
            25% { transform: translateY(-30px) translateX(15px); opacity: 0.6; }
            50% { transform: translateY(-15px) translateX(-10px); opacity: 0.4; }
            75% { transform: translateY(-40px) translateX(20px); opacity: 0.5; }
        }

        /* ========== MAIN CONTAINER ========== */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* ========== HEADER SECTION ========== */
        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        .header .subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .header .grade-badge {
            display: inline-block;
            padding: 8px 20px;
            background: var(--secondary-gradient);
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* ========== STATS BAR ========== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            animation: fadeIn 1s ease-out 0.3s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-md);
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            transition: var(--transition-medium);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--secondary-gradient);
            transform: scaleX(0);
            transition: var(--transition-medium);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-card .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ========== CONTROL PANEL ========== */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-md);
            backdrop-filter: blur(10px);
            animation: fadeIn 1s ease-out 0.5s both;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Custom Select Dropdown */
        .custom-select {
            position: relative;
            min-width: 180px;
        }

        .custom-select select {
            width: 100%;
            padding: 12px 40px 12px 15px;
            background: var(--input-bg);
            border: 2px solid var(--card-border);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            transition: var(--transition-fast);
        }

        .custom-select select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px var(--input-focus);
        }

        .custom-select::after {
            content: '▼';
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
            font-size: 0.8rem;
        }

        .custom-select option {
            background: #1a1a2e;
            color: var(--text-primary);
            padding: 10px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition-medium);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--secondary-gradient);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-success {
            background: linear-gradient(135deg, #00d26a 0%, #00a854 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 210, 106, 0.4);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 210, 106, 0.6);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffa502 0%, #ff7f00 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 165, 2, 0.4);
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 165, 2, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.6);
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 2px solid var(--card-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #667eea;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ========== TIMER DISPLAY ========== */
        .timer-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            background: var(--input-bg);
            border: 2px solid var(--card-border);
            border-radius: var(--border-radius-sm);
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .timer-display.running {
            border-color: var(--success-color);
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 210, 106, 0.4); }
            50% { box-shadow: 0 0 0 5px rgba(0, 210, 106, 0); }
        }

        .timer-icon {
            font-size: 1.3rem;
        }

        /* ========== PROBLEM CARD ========== */
        .problem-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--card-border);
        }

        .problem-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .problem-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--secondary-gradient);
            border-radius: 50%;
            font-weight: 700;
            margin-right: 10px;
        }

        .difficulty-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .difficulty-easy {
            background: rgba(0, 210, 106, 0.2);
            color: #00d26a;
            border: 1px solid rgba(0, 210, 106, 0.3);
        }

        .difficulty-medium {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 1px solid rgba(255, 165, 2, 0.3);
        }

        .difficulty-hard {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            border: 1px solid rgba(255, 71, 87, 0.3);
        }

        /* Problem Details Grid */
        .problem-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--card-border);
            transition: var(--transition-fast);
        }

        .detail-item:hover {
            border-color: #667eea;
            transform: translateX(5px);
        }

        .detail-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary-gradient);
            border-radius: var(--border-radius-sm);
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .detail-content {
            flex: 1;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Problem Question Text */
        .problem-question {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--border-radius-md);
            padding: 25px;
            margin-bottom: 25px;
            font-size: 1.05rem;
            line-height: 1.8;
        }

        .problem-question p {
            margin-bottom: 10px;
        }

        .problem-question p:last-child {
            margin-bottom: 0;
        }

        .highlight {
            color: #667eea;
            font-weight: 600;
        }

        /* ========== T-ACCOUNT TABLE STYLES ========== */
        .account-section {
            margin-bottom: 40px;
        }

        .account-title {
            text-align: center;
            font-weight: 700;
            font-size: 1.4rem;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--secondary-gradient);
            border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .t-account-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-medium);
        }

        .t-account-table th,
        .t-account-table td {
            border: 1px solid var(--card-border);
            padding: 12px 15px;
            font-size: 0.95rem;
        }

        .t-account-table th {
            background: var(--table-header);
            color: var(--text-primary);
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
        }

        .t-account-table .dr-header,
        .t-account-table .cr-header {
            font-size: 1rem;
            padding: 15px;
            background: linear-gradient(135deg, #2d3a4f 0%, #3d4a5f 100%);
        }

        .t-account-table .dr-header {
            border-right: 2px solid #667eea;
        }

        .t-account-table .cr-header {
            border-left: 2px solid #667eea;
        }

        .t-account-table td {
            vertical-align: middle;
            background: var(--table-row-even);
        }

        .t-account-table tr:nth-child(odd) td {
            background: var(--table-row-odd);
        }

        .t-account-table .amount-cell {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }

        .t-account-table .date-cell {
            width: 120px;
            white-space: nowrap;
        }

        .t-account-table .particulars-cell {
            min-width: 200px;
        }

        .t-account-table .total-row {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%) !important;
            font-weight: 700;
        }

        .t-account-table .total-row td {
            background: transparent !important;
            border-top: 2px solid #667eea;
        }

        /* ========== INPUT FIELDS IN TABLE ========== */
        .table-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--input-bg);
            border: 2px solid var(--card-border);
            border-radius: var(--border-radius-sm);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: var(--transition-fast);
            text-align: right;
        }

        .table-input.text-input {
            text-align: left;
        }

        .table-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px var(--input-focus);
            background: rgba(102, 126, 234, 0.1);
        }

        .table-input::placeholder {
            color: rgba(184, 197, 214, 0.5);
            font-style: italic;
        }

        /* Input validation states */
        .table-input.correct {
            border-color: var(--success-color) !important;
            background: rgba(0, 210, 106, 0.15) !important;
            box-shadow: 0 0 0 3px rgba(0, 210, 106, 0.2);
        }

        .table-input.incorrect {
            border-color: var(--error-color) !important;
            background: rgba(255, 71, 87, 0.15) !important;
            box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.2);
        }

        /* Correct answer display */
        .correct-answer {
            display: none;
            font-size: 0.8rem;
            color: var(--success-color);
            margin-top: 5px;
            font-weight: 600;
        }

        .correct-answer.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        /* ========== YEAR SEPARATOR ========== */
        .year-separator {
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.5), transparent) !important;
            height: 3px;
            padding: 0 !important;
        }

        .year-separator td {
            padding: 0 !important;
            height: 3px !important;
            border: none !important;
        }

        /* ========== RESPONSIVE TABLE WRAPPER ========== */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--border-radius-md);
            margin-bottom: 30px;
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--secondary-gradient);
            border-radius: 4px;
        }

        /* ========== RESULTS SECTION ========== */
        .results-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-medium);
            animation: slideUp 0.6s ease-out;
        }

        .results-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .results-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .results-title.excellent {
            color: var(--success-color);
        }

        .results-title.good {
            color: #667eea;
        }

        .results-title.average {
            color: var(--warning-color);
        }

        .results-title.needs-improvement {
            color: var(--error-color);
        }

        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .score-circle {
            position: relative;
            width: 150px;
            height: 150px;
        }

        .score-circle svg {
            transform: rotate(-90deg);
            width: 150px;
            height: 150px;
        }

        .score-circle .bg-circle {
            fill: none;
            stroke: var(--input-bg);
            stroke-width: 10;
        }

        .score-circle .progress-circle {
            fill: none;
            stroke: url(#scoreGradient);
            stroke-width: 10;
            stroke-linecap: round;
            stroke-dasharray: 408;
            stroke-dashoffset: 408;
            transition: stroke-dashoffset 1.5s ease-out;
        }

        .score-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .score-percentage {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .score-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .score-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-detail-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            background: var(--input-bg);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--card-border);
        }

        .score-detail-icon {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1.3rem;
        }

        .score-detail-icon.correct {
            background: rgba(0, 210, 106, 0.2);
            color: var(--success-color);
        }

        .score-detail-icon.incorrect {
            background: rgba(255, 71, 87, 0.2);
            color: var(--error-color);
        }

        .score-detail-icon.total {
            background: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .score-detail-info {
            flex: 1;
        }

        .score-detail-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .score-detail-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Detailed Feedback */
        .feedback-section {
            margin-top: 30px;
        }

        .feedback-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--card-border);
        }

        .feedback-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .feedback-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: var(--input-bg);
            border-radius: var(--border-radius-sm);
            border-left: 4px solid;
            transition: var(--transition-fast);
        }

        .feedback-item:hover {
            transform: translateX(5px);
        }

        .feedback-item.correct {
            border-color: var(--success-color);
            background: rgba(0, 210, 106, 0.05);
        }

        .feedback-item.incorrect {
            border-color: var(--error-color);
            background: rgba(255, 71, 87, 0.05);
        }

        .feedback-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .feedback-item.correct .feedback-icon {
            background: rgba(0, 210, 106, 0.2);
            color: var(--success-color);
        }

        .feedback-item.incorrect .feedback-icon {
            background: rgba(255, 71, 87, 0.2);
            color: var(--error-color);
        }

        .feedback-content {
            flex: 1;
        }

        .feedback-field {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .feedback-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .feedback-values {
            display: flex;
            gap: 20px;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .feedback-your-answer {
            color: var(--error-color);
        }

        .feedback-correct-answer {
            color: var(--success-color);
        }

        /* ========== MODAL STYLES ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-medium);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.8) translateY(-50px);
            transition: var(--transition-medium);
            box-shadow: var(--shadow-heavy);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-content.modal-large {
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            background: var(--secondary-gradient);
            border-bottom: 1px solid var(--card-border);
        }

        .modal-header h3 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .modal-close {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: var(--transition-fast);
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 25px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-body::-webkit-scrollbar {
            width: 6px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: var(--input-bg);
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: var(--secondary-gradient);
            border-radius: 3px;
        }

        /* Hint Modal Content */
        .hint-section {
            margin-bottom: 20px;
        }

        .hint-section:last-child {
            margin-bottom: 0;
        }

        .hint-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .hint-text {
            background: var(--input-bg);
            padding: 15px;
            border-radius: var(--border-radius-sm);
            border-left: 3px solid #667eea;
            line-height: 1.7;
        }

        .hint-formula {
            font-family: 'Courier New', monospace;
            background: rgba(102, 126, 234, 0.2);
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            text-align: center;
            font-size: 1.1rem;
            margin: 15px 0;
            border: 1px dashed rgba(102, 126, 234, 0.5);
        }

        /* Solution Modal Content */
        .solution-step {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--card-border);
        }

        .solution-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .solution-step-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .solution-step-number {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary-gradient);
            border-radius: 50%;
            font-weight: 700;
            flex-shrink: 0;
        }

        .solution-step-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .solution-calculation {
            background: var(--input-bg);
            padding: 15px 20px;
            border-radius: var(--border-radius-sm);
            font-family: 'Courier New', monospace;
            line-height: 1.8;
        }

        .solution-calculation .calc-line {
            margin-bottom: 8px;
        }

        .solution-calculation .calc-result {
            color: var(--success-color);
            font-weight: 700;
            padding-top: 10px;
            border-top: 1px dashed var(--card-border);
            margin-top: 10px;
        }

        /* ========== TOAST NOTIFICATIONS ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-sm);
            box-shadow: var(--shadow-medium);
            transform: translateX(120%);
            transition: var(--transition-medium);
            min-width: 280px;
            max-width: 400px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--error-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast.info {
            border-left: 4px solid #667eea;
        }

        .toast-icon {
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            transition: var(--transition-fast);
        }

        .toast-close:hover {
            color: var(--text-primary);
        }

        /* ========== LOADING SPINNER ========== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-medium);
        }

        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--input-bg);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        /* ========== EMPTY STATE ========== */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            background: var(--card-bg);
            border: 2px dashed var(--card-border);
            border-radius: var(--border-radius-lg);
            margin: 30px 0;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-state-text {
            color: var(--text-secondary);
            max-width: 400px;
            margin: 0 auto 25px;
        }

        /* ========== TOOLTIP ========== */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-5px);
            background: #1a1a2e;
            border: 1px solid var(--card-border);
            padding: 8px 15px;
            border-radius: var(--border-radius-sm);
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-fast);
            z-index: 100;
            box-shadow: var(--shadow-light);
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1a1a2e;
        }

        .tooltip-wrapper:hover .tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }

        /* ========== PROGRESS BAR ========== */
        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .progress-bar {
            height: 10px;
            background: var(--input-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-gradient);
            border-radius: 5px;
            transition: width 0.8s ease-out;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            from { transform: translateX(-100%); }
            to { transform: translateX(100%); }
        }

        /* ========== INPUT CELL CONTAINER ========== */
        .input-cell {
            position: relative;
        }

        .input-cell .validation-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .input-cell.validated .validation-icon {
            opacity: 1;
        }

        .input-cell.correct .validation-icon {
            color: var(--success-color);
        }

        .input-cell.incorrect .validation-icon {
            color: var(--error-color);
        }

        /* ========== ACTION BUTTONS ROW ========== */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* ========== PRINT STYLES ========== */
        @media print {
            body {
                background: white;
                color: black;
            }

            .background-animation,
            .control-panel,
            .stats-bar,
            .header,
            .btn,
            .modal-overlay,
            .toast-container {
                display: none !important;
            }

            .main-container {
                max-width: 100%;
                padding: 0;
            }

            .problem-card,
            .account-section,
            .results-section {
                box-shadow: none;
                border: 1px solid #ccc;
                background: white;
            }

            .t-account-table th,
            .t-account-table td {
                border-color: #333;
            }

            .table-input {
                border: 1px solid #999;
                background: white;
            }
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media screen and (max-width: 1200px) {
            .main-container {
                padding: 15px;
            }

            .problem-details {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media screen and (max-width: 992px) {
            .header h1 {
                font-size: 2rem;
            }

            .control-panel {
                flex-direction: column;
                gap: 12px;
            }

            .control-group {
                width: 100%;
                justify-content: center;
            }

            .custom-select {
                min-width: 200px;
            }

            .btn {
                width: 100%;
                max-width: 250px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .score-display {
                flex-direction: column;
                gap: 25px;
            }
        }

        @media screen and (max-width: 768px) {
            .header {
                padding: 25px 15px;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .header .subtitle {
                font-size: 0.95rem;
            }

            .problem-card {
                padding: 20px;
            }

            .problem-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .problem-title {
                font-size: 1.2rem;
            }

            .problem-details {
                grid-template-columns: 1fr;
            }

            .detail-item {
                padding: 12px;
            }

            .account-title {
                font-size: 1.1rem;
                padding: 12px;
            }

            .t-account-table th,
            .t-account-table td {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .table-input {
                padding: 8px 10px;
                font-size: 0.85rem;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-card .stat-value {
                font-size: 1.4rem;
            }

            .stat-card .stat-label {
                font-size: 0.75rem;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }

            .modal-body {
                padding: 20px;
            }

            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }

            .toast {
                min-width: auto;
                max-width: none;
            }
        }

        @media screen and (max-width: 480px) {
            .header h1 {
                font-size: 1.4rem;
            }

            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }

            .timer-display {
                font-size: 1rem;
                padding: 10px 15px;
            }

            .problem-question {
                padding: 15px;
                font-size: 0.95rem;
            }

            .t-account-table {
                font-size: 0.8rem;
            }

            .t-account-table th,
            .t-account-table td {
                padding: 6px 8px;
            }

            .table-input {
                padding: 6px 8px;
                font-size: 0.8rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }

            .feedback-item {
                padding: 12px;
                flex-direction: column;
                gap: 10px;
            }

            .feedback-values {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* ========== CUSTOM SCROLLBAR ========== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--input-bg);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd6 0%, #6a4190 100%);
        }

        /* ========== SELECTION STYLES ========== */
        ::selection {
            background: rgba(102, 126, 234, 0.3);
            color: white;
        }

        /* ========== FOCUS VISIBLE ========== */
        :focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* ========== ACCESSIBILITY ========== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* ========== YEAR LABEL IN TABLE ========== */
        .year-label {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            font-weight: 700;
            text-align: center;
            color: #667eea;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .year-label td {
            background: transparent !important;
            border-left: none !important;
            border-right: none !important;
        }

        /* ========== BALANCE ROW STYLING ========== */
        .balance-row {
            background: rgba(102, 126, 234, 0.08) !important;
        }

        .balance-row td {
            background: transparent !important;
            font-weight: 600;
        }

        /* ========== INSTRUCTIONS PANEL ========== */
        .instructions-panel {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: var(--border-radius-md);
            padding: 20px 25px;
            margin-bottom: 25px;
        }

        .instructions-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
        }

        .instructions-list {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }

        .instructions-list li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        .instructions-list li::before {
            content: '•';
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
            line-height: 1.2;
        }

        /* ========== KEYBOARD SHORTCUT HINTS ========== */
        .shortcut-hint {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 10px;
        }

        .shortcut-key {
            display: inline-block;
            padding: 2px 6px;
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
        }

        /* ========== DEPRECIATION FORMULA CARD ========== */
        .formula-card {
            background: linear-gradient(135deg, rgba(0, 210, 106, 0.1) 0%, rgba(0, 168, 84, 0.1) 100%);
            border: 1px solid rgba(0, 210, 106, 0.3);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .formula-card .formula-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--success-color);
        }

        .formula-card .formula-text {
            font-family: 'Courier New', monospace;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: var(--border-radius-sm);
            display: inline-block;
        }

        /* ========== CONFETTI ANIMATION (for correct answers) ========== */
        .confetti {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s linear forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(0) rotateZ(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotateZ(720deg);
            }
        }

        /* ========== SHAKE ANIMATION (for wrong answers) ========== */
        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* ========== GLOW EFFECT ========== */
        .glow-success {
            box-shadow: 0 0 20px rgba(0, 210, 106, 0.5);
        }

        .glow-error {
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
        }

        /* ========== CELEBRATION OVERLAY ========== */
        .celebration-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9998;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .celebration-overlay.active {
            opacity: 1;
        }

        .celebration-text {
            font-size: 4rem;
            font-weight: 700;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: celebrationPop 0.5s ease-out;
        }

        @keyframes celebrationPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="background-animation"></div>
    
    <!-- Floating Particles (Generated via JS) -->
    <div id="particles-container"></div>

    <!-- Main Container -->
    <div class="main-container">
        
        <!-- Header Section -->
        <header class="header">
            <h1>📊 Depreciation Accounting Practice</h1>
            <p class="subtitle">Master the Straight Line Method with Interactive Problems</p>
            <span class="grade-badge">Grade 11 - DK Goyal Pattern</span>
        </header>

        <!-- Statistics Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon">📝</div>
                <div class="stat-value" id="problemsAttempted">0</div>
                <div class="stat-label">Problems Attempted</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-value" id="correctAnswers">0</div>
                <div class="stat-label">Correct Answers</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">📈</div>
                <div class="stat-value" id="accuracyRate">0%</div>
                <div class="stat-label">Accuracy Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">🏆</div>
                <div class="stat-value" id="currentStreak">0</div>
                <div class="stat-label">Current Streak</div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-group">
                <label for="difficulty">Difficulty:</label>
                <div class="custom-select">
                    <select id="difficulty">
                        <option value="easy">🟢 Easy</option>
                        <option value="medium" selected>🟡 Medium</option>
                        <option value="hard">🔴 Hard</option>
                    </select>
                </div>
            </div>

            <div class="control-group">
                <label for="mode">Mode:</label>
                <div class="custom-select">
                    <select id="mode">
                        <option value="practice">📚 Practice</option>
                        <option value="exam">📋 Exam</option>
                    </select>
                </div>
            </div>

            <div class="timer-display" id="timerDisplay">
                <span class="timer-icon">⏱️</span>
                <span id="timerValue">00:00</span>
            </div>

            <button class="btn btn-primary" id="newProblemBtn">
                🎲 New Problem
            </button>

            <button class="btn btn-success" id="checkAnswersBtn" disabled>
                ✓ Check Answers
            </button>

            <button class="btn btn-warning" id="showSolutionBtn" disabled>
                💡 Show Solution
            </button>

            <button class="btn btn-secondary" id="resetBtn" disabled>
                🔄 Reset
            </button>

            <button class="btn btn-secondary" id="hintBtn" disabled>
                💭 Hint
            </button>
        </div>

        <!-- Problem Card -->
        <div class="problem-card" id="problemCard" style="display: none;">
            <div class="problem-header">
                <div class="problem-title">
                    <span class="problem-number" id="problemNumber">1</span>
                    <span id="problemTitleText">Depreciation Problem</span>
                </div>
                <span class="difficulty-badge difficulty-medium" id="difficultyBadge">Medium</span>
            </div>

            <!-- Problem Details -->
            <div class="problem-details" id="problemDetails">
                <!-- Filled dynamically -->
            </div>

            <!-- Problem Question -->
            <div class="problem-question" id="problemQuestion">
                <!-- Filled dynamically -->
            </div>
        </div>

        <!-- Asset Account Section -->
        <div class="account-section" id="assetAccountSection" style="display: none;">
            <div class="account-title" id="assetAccountTitle">Machinery Account</div>
            <div class="table-wrapper">
                <table class="t-account-table" id="assetAccountTable">
                    <thead>
                        <tr>
                            <th colspan="3" class="dr-header">Dr.</th>
                            <th colspan="3" class="cr-header">Cr.</th>
                        </tr>
                        <tr>
                            <th class="date-cell">Date</th>
                            <th class="particulars-cell">Particulars</th>
                            <th>Amount (₹)</th>
                            <th class="date-cell">Date</th>
                            <th class="particulars-cell">Particulars</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="assetAccountBody">
                        <!-- Rows generated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Depreciation Account Section -->
        <div class="account-section" id="depreciationAccountSection" style="display: none;">
            <div class="account-title">Depreciation Account</div>
            <div class="table-wrapper">
                <table class="t-account-table" id="depreciationAccountTable">
                    <thead>
                        <tr>
                            <th colspan="3" class="dr-header">Dr.</th>
                            <th colspan="3" class="cr-header">Cr.</th>
                        </tr>
                        <tr>
                            <th class="date-cell">Date</th>
                            <th class="particulars-cell">Particulars</th>
                            <th>Amount (₹)</th>
                            <th class="date-cell">Date</th>
                            <th class="particulars-cell">Particulars</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="depreciationAccountBody">
                        <!-- Rows generated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Profit/Loss on Sale Section (if applicable) -->
        <div class="account-section" id="profitLossSection" style="display: none;">
            <div class="account-title" id="profitLossTitle">Profit & Loss on Sale of Asset</div>
            <div class="table-wrapper">
                <table class="t-account-table" id="profitLossTable">
                    <thead>
                        <tr>
                            <th colspan="3" class="dr-header">Dr.</th>
                            <th colspan="3" class="cr-header">Cr.</th>
                        </tr>
                        <tr>
                            <th class="date-cell">Date</th>
                            <th class="particulars-cell">Particulars</th>
                            <th>Amount (₹)</th>
                            <th class="date-cell">Date</th>
                            <th class="particulars-cell">Particulars</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody id="profitLossBody">
                        <!-- Rows generated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <!-- Filled after checking answers -->
        </div>

        <!-- Hint Modal -->
        <div class="modal-overlay" id="hintModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>💭 Hint</h3>
                    <button class="modal-close" id="closeHintModal">&times;</button>
                </div>
                <div class="modal-body" id="hintContent">
                    <!-- Hint content -->
                </div>
            </div>
        </div>

        <!-- Solution Modal -->
        <div class="modal-overlay" id="solutionModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h3>📝 Complete Solution</h3>
                    <button class="modal-close" id="closeSolutionModal">&times;</button>
                </div>
                <div class="modal-body" id="solutionContent">
                    <!-- Solution content -->
                </div>
            </div>
        </div>

    </div>

        <script>
        /* ========================================================
           DEPRECIATION PRACTICE APPLICATION
           Part 3: Data Structures & Problem Generation
           ======================================================== */

        // ========== GLOBAL STATE MANAGEMENT ==========
        const AppState = {
            currentProblem: null,
            correctAnswers: {},
            userAnswers: {},
            isChecked: false,
            isSolutionShown: false,
            timerInterval: null,
            timerSeconds: 0,
            isTimerRunning: false,
            problemCount: 0,
            stats: {
                problemsAttempted: 0,
                correctAnswers: 0,
                totalFields: 0,
                correctFields: 0,
                currentStreak: 0,
                bestStreak: 0
            }
        };

        // ========== ASSET DATA ==========
        const AssetData = {
            // Asset types with their typical names
            assetTypes: [
                {
                    type: 'Machinery',
                    names: ['Machinery', 'Plant and Machinery', 'Manufacturing Equipment', 'Industrial Machinery', 'Factory Equipment'],
                    accountName: 'Machinery Account',
                    typicalRates: [10, 15, 20]
                },
                {
                    type: 'Furniture',
                    names: ['Furniture', 'Furniture and Fixtures', 'Office Furniture', 'Furniture and Fittings'],
                    accountName: 'Furniture Account',
                    typicalRates: [10, 15]
                },
                {
                    type: 'Vehicle',
                    names: ['Motor Vehicle', 'Delivery Van', 'Motor Car', 'Truck', 'Vehicle'],
                    accountName: 'Motor Vehicle Account',
                    typicalRates: [15, 20, 25]
                },
                {
                    type: 'Computer',
                    names: ['Computer', 'Computer Equipment', 'Office Computer', 'Computer Systems'],
                    accountName: 'Computer Account',
                    typicalRates: [20, 25, 40]
                },
                {
                    type: 'Building',
                    names: ['Building', 'Factory Building', 'Office Building', 'Warehouse'],
                    accountName: 'Building Account',
                    typicalRates: [5, 10]
                },
                {
                    type: 'Equipment',
                    names: ['Equipment', 'Office Equipment', 'Lab Equipment', 'Testing Equipment'],
                    accountName: 'Equipment Account',
                    typicalRates: [10, 15, 20]
                }
            ],

            // Purchase sources
            purchaseSources: [
                'Bank A/c',
                'Cash A/c',
                'Cheque',
                'M/s Sharma & Co.',
                'M/s Gupta Traders',
                'ABC Ltd.',
                'XYZ Corporation',
                'National Machinery Co.'
            ],

            // Sale destinations
            saleDestinations: [
                'Bank A/c',
                'Cash A/c',
                'Cheque',
                'M/s Patel Bros.',
                'M/s Singh Enterprises',
                'DEF Ltd.',
                'Old Assets Dealer'
            ],

            // Additional costs that can be added to purchase price
            additionalCosts: [
                { name: 'Installation Charges', minPercent: 5, maxPercent: 15 },
                { name: 'Transportation Charges', minPercent: 2, maxPercent: 8 },
                { name: 'Freight Charges', minPercent: 2, maxPercent: 5 },
                { name: 'Erection Expenses', minPercent: 5, maxPercent: 10 },
                { name: 'Carriage', minPercent: 1, maxPercent: 5 }
            ]
        };

        // ========== DATE UTILITIES ==========
        const DateUtils = {
            // Financial year months (April to March in India)
            financialYearEnd: { month: 3, day: 31 }, // March 31

            // Parse date string to object
            parseDate(dateStr) {
                const parts = dateStr.split('-');
                return {
                    year: parseInt(parts[0]),
                    month: parseInt(parts[1]),
                    day: parseInt(parts[2])
                };
            },

            // Format date for display
            formatDate(year, month, day) {
                const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'June', 
                               'July', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'];
                return `${year} ${months[month - 1]} ${String(day).padStart(2, '0')}`;
            },

            // Format date short version
            formatDateShort(year, month, day) {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${day} ${months[month - 1]} ${year}`;
            },

            // Get financial year end date
            getFinancialYearEnd(purchaseYear, purchaseMonth) {
                // If purchase is between April and December, FY ends on March 31 of next year
                // If purchase is between January and March, FY ends on March 31 of same year
                if (purchaseMonth >= 4) {
                    return { year: purchaseYear + 1, month: 3, day: 31 };
                } else {
                    return { year: purchaseYear, month: 3, day: 31 };
                }
            },

            // Calculate months between two dates
            calculateMonths(fromYear, fromMonth, fromDay, toYear, toMonth, toDay) {
                let months = (toYear - fromYear) * 12 + (toMonth - fromMonth);
                
                // If the day of purchase is after the 1st, we might count partial month
                // For simplicity in accounting, if purchased after 15th, that month is not counted
                // if purchased on or before 15th, that month is counted
                if (fromDay > 15) {
                    // Month of purchase not counted (starts from next month)
                    // No adjustment needed as we calculate from month
                } else {
                    // Month of purchase is counted
                    months += 1;
                }

                // For the ending month, if we're not at the end of month
                if (toDay < 28) {
                    // Don't count the ending month fully
                    // But for year end (March 31), we count full
                }

                return months;
            },

            // Calculate depreciation months for first year
            calculateFirstYearMonths(purchaseMonth, purchaseDay) {
                // From purchase date to March 31 (financial year end)
                let months;
                if (purchaseMonth <= 3) {
                    // January to March - calculate months until March
                    months = 3 - purchaseMonth + 1;
                    if (purchaseDay > 1) {
                        // If not purchased on 1st, reduce accordingly
                        // For simplicity: if purchased after 15th, don't count that month
                        if (purchaseDay > 15) {
                            months -= 1;
                        }
                    }
                } else {
                    // April to December - months until March of next year
                    months = 12 - purchaseMonth + 3 + 1; // +1 to include March
                    if (purchaseDay > 15) {
                        months -= 1;
                    }
                }
                return Math.max(1, months); // At least 1 month
            },

            // Calculate months for sale year (partial year)
            calculateSaleYearMonths(saleMonth, saleDay) {
                // From April 1 to sale date
                let months;
                if (saleMonth >= 4) {
                    // April onwards
                    months = saleMonth - 4 + 1;
                    if (saleDay < 15) {
                        months -= 1;
                    }
                } else {
                    // January to March (same financial year, so from April of prev year)
                    months = 12 - 4 + saleMonth + 1;
                    if (saleDay < 15) {
                        months -= 1;
                    }
                }
                return Math.max(0, months);
            },

            // Generate random date within a year
            generateRandomDate(year, monthRange = null) {
                let month, day;
                if (monthRange) {
                    month = this.randomInt(monthRange.min, monthRange.max);
                } else {
                    month = this.randomInt(1, 12);
                }
                
                // Days in each month
                const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                day = this.randomInt(1, daysInMonth[month - 1]);
                
                return { year, month, day };
            },

            // Random integer between min and max (inclusive)
            randomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
        };

        // ========== CALCULATION ENGINE ==========
        const CalculationEngine = {
            // Calculate annual depreciation using Straight Line Method
            calculateSLMDepreciation(cost, rate) {
                return Math.round(cost * rate / 100);
            },

            // Calculate depreciation for partial year
            calculatePartialDepreciation(cost, rate, months) {
                const annualDepreciation = this.calculateSLMDepreciation(cost, rate);
                return Math.round(annualDepreciation * months / 12);
            },

            // Calculate book value
            calculateBookValue(cost, accumulatedDepreciation) {
                return cost - accumulatedDepreciation;
            },

            // Calculate profit or loss on sale
            calculateProfitLoss(salePrice, bookValue) {
                const difference = salePrice - bookValue;
                return {
                    amount: Math.abs(difference),
                    isProfit: difference > 0,
                    isLoss: difference < 0,
                    isNil: difference === 0
                };
            },

            // Generate complete depreciation schedule
            generateDepreciationSchedule(problem) {
                const schedule = {
                    years: [],
                    assetAccountEntries: [],
                    depreciationAccountEntries: [],
                    profitLossEntries: null
                };

                const { 
                    purchaseDate, 
                    purchasePrice, 
                    additionalCost,
                    depreciationRate, 
                    numberOfYears,
                    hasSale,
                    saleDate,
                    salePrice 
                } = problem;

                const totalCost = purchasePrice + (additionalCost || 0);
                let currentBookValue = totalCost;
                let accumulatedDepreciation = 0;
                const annualDepreciation = this.calculateSLMDepreciation(totalCost, depreciationRate);

                // Calculate first year depreciation (may be partial)
                const firstYearMonths = DateUtils.calculateFirstYearMonths(
                    purchaseDate.month, 
                    purchaseDate.day
                );
                const isFirstYearPartial = firstYearMonths < 12;

                // Track financial years
                let currentFYStart = purchaseDate.month >= 4 ? purchaseDate.year : purchaseDate.year - 1;
                
                // Generate entries for each year
                for (let yearIndex = 0; yearIndex < numberOfYears; yearIndex++) {
                    const fyStartYear = currentFYStart + yearIndex;
                    const fyEndYear = fyStartYear + 1;
                    
                    let depreciation;
                    let depreciationMonths = 12;
                    let isSaleYear = false;
                    let saleYearMonths = 0;

                    // Check if this is sale year
                    if (hasSale && saleDate) {
                        const saleFYStart = saleDate.month >= 4 ? saleDate.year : saleDate.year - 1;
                        if (saleFYStart === fyStartYear) {
                            isSaleYear = true;
                            saleYearMonths = DateUtils.calculateSaleYearMonths(saleDate.month, saleDate.day);
                            depreciationMonths = saleYearMonths;
                        }
                    }

                    // Calculate depreciation for this year
                    if (yearIndex === 0 && isFirstYearPartial) {
                        depreciationMonths = firstYearMonths;
                        depreciation = this.calculatePartialDepreciation(totalCost, depreciationRate, firstYearMonths);
                    } else if (isSaleYear && saleYearMonths > 0) {
                        depreciation = this.calculatePartialDepreciation(totalCost, depreciationRate, saleYearMonths);
                    } else if (isSaleYear && saleYearMonths === 0) {
                        depreciation = 0;
                    } else {
                        depreciation = annualDepreciation;
                    }

                    const openingBalance = currentBookValue;
                    accumulatedDepreciation += depreciation;
                    currentBookValue = totalCost - accumulatedDepreciation;
                    const closingBalance = currentBookValue;

                    schedule.years.push({
                        yearIndex,
                        fyStartYear,
                        fyEndYear,
                        openingBalance: Math.round(openingBalance),
                        depreciation: Math.round(depreciation),
                        depreciationMonths,
                        accumulatedDepreciation: Math.round(accumulatedDepreciation),
                        closingBalance: Math.round(closingBalance),
                        isSaleYear,
                        isFirstYear: yearIndex === 0,
                        isPartialYear: (yearIndex === 0 && isFirstYearPartial) || isSaleYear
                    });

                    // If sale year, stop after this year
                    if (isSaleYear) {
                        break;
                    }
                }

                // Generate Asset Account entries
                this.generateAssetAccountEntries(schedule, problem, totalCost);

                // Generate Depreciation Account entries
                this.generateDepreciationAccountEntries(schedule, problem);

                // Generate Profit/Loss entries if sale
                if (hasSale) {
                    this.generateProfitLossEntries(schedule, problem);
                }

                return schedule;
            },

            // Generate Asset Account T-format entries
            generateAssetAccountEntries(schedule, problem, totalCost) {
                const entries = [];
                const { 
                    purchaseDate, 
                    purchasePrice,
                    additionalCost,
                    purchaseSource,
                    hasSale,
                    saleDate,
                    salePrice,
                    assetName
                } = problem;

                let yearlyEntries = [];

                schedule.years.forEach((year, index) => {
                    const yearEntry = {
                        yearIndex: index,
                        fyStartYear: year.fyStartYear,
                        fyEndYear: year.fyEndYear,
                        debitEntries: [],
                        creditEntries: [],
                        debitTotal: 0,
                        creditTotal: 0
                    };

                    // DEBIT SIDE
                    if (index === 0) {
                        // First year - Purchase entry
                        let particulars;
                        if (additionalCost && additionalCost > 0) {
                            particulars = `To ${purchaseSource} (${this.formatCurrency(purchasePrice)} + ${this.formatCurrency(additionalCost)})`;
                        } else {
                            particulars = `To ${purchaseSource}`;
                        }

                        yearEntry.debitEntries.push({
                            date: DateUtils.formatDate(purchaseDate.year, purchaseDate.month, purchaseDate.day),
                            particulars: particulars,
                            amount: totalCost,
                            type: 'purchase'
                        });
                    } else {
                        // Subsequent years - Balance b/d
                        yearEntry.debitEntries.push({
                            date: DateUtils.formatDate(year.fyStartYear, 4, 1),
                            particulars: 'To Balance b/d',
                            amount: year.openingBalance,
                            type: 'balance_bd'
                        });
                    }

                    // CREDIT SIDE
                    // Depreciation entry
                    if (year.depreciation > 0) {
                        let depParticulars = 'By Depreciation A/c';
                        if (year.isPartialYear && year.depreciationMonths !== 12) {
                            depParticulars = `By Depreciation A/c (for ${year.depreciationMonths} months)`;
                        }

                        yearEntry.creditEntries.push({
                            date: year.isSaleYear && hasSale ? 
                                DateUtils.formatDate(saleDate.year, saleDate.month, saleDate.day) :
                                DateUtils.formatDate(year.fyEndYear, 3, 31),
                            particulars: depParticulars,
                            amount: year.depreciation,
                            type: 'depreciation'
                        });
                    }

                    // Sale or Balance c/d
                    if (year.isSaleYear && hasSale) {
                        // Sale entry
                        const bookValueAtSale = year.openingBalance - year.depreciation;
                        const profitLoss = this.calculateProfitLoss(salePrice, bookValueAtSale);

                        yearEntry.creditEntries.push({
                            date: DateUtils.formatDate(saleDate.year, saleDate.month, saleDate.day),
                            particulars: `By Bank A/c (Sale)`,
                            amount: salePrice,
                            type: 'sale'
                        });

                        if (profitLoss.isLoss) {
                            yearEntry.creditEntries.push({
                                date: DateUtils.formatDate(saleDate.year, saleDate.month, saleDate.day),
                                particulars: 'By Profit & Loss A/c (Loss on Sale)',
                                amount: profitLoss.amount,
                                type: 'loss'
                            });
                        } else if (profitLoss.isProfit) {
                            // Profit goes on debit side
                            yearEntry.debitEntries.push({
                                date: DateUtils.formatDate(saleDate.year, saleDate.month, saleDate.day),
                                particulars: 'To Profit & Loss A/c (Profit on Sale)',
                                amount: profitLoss.amount,
                                type: 'profit'
                            });
                        }
                    } else {
                        // Balance c/d
                        yearEntry.creditEntries.push({
                            date: DateUtils.formatDate(year.fyEndYear, 3, 31),
                            particulars: 'By Balance c/d',
                            amount: year.closingBalance,
                            type: 'balance_cd'
                        });
                    }

                    // Calculate totals
                    yearEntry.debitTotal = yearEntry.debitEntries.reduce((sum, e) => sum + e.amount, 0);
                    yearEntry.creditTotal = yearEntry.creditEntries.reduce((sum, e) => sum + e.amount, 0);

                    yearlyEntries.push(yearEntry);
                });

                schedule.assetAccountEntries = yearlyEntries;
            },

            // Generate Depreciation Account T-format entries
            generateDepreciationAccountEntries(schedule, problem) {
                const entries = [];
                const { assetName, hasSale, saleDate } = problem;

                schedule.years.forEach((year, index) => {
                    if (year.depreciation === 0) return;

                    const yearEntry = {
                        yearIndex: index,
                        fyStartYear: year.fyStartYear,
                        fyEndYear: year.fyEndYear,
                        debitEntries: [],
                        creditEntries: [],
                        debitTotal: 0,
                        creditTotal: 0
                    };

                    const entryDate = year.isSaleYear && hasSale ?
                        DateUtils.formatDate(saleDate.year, saleDate.month, saleDate.day) :
                        DateUtils.formatDate(year.fyEndYear, 3, 31);

                    // DEBIT SIDE - Amount from Asset Account
                    let depParticulars = `To ${assetName} A/c`;
                    if (year.isPartialYear && year.depreciationMonths !== 12) {
                        depParticulars = `To ${assetName} A/c (for ${year.depreciationMonths} months)`;
                    }

                    yearEntry.debitEntries.push({
                        date: entryDate,
                        particulars: depParticulars,
                        amount: year.depreciation,
                        type: 'asset_depreciation'
                    });

                    // CREDIT SIDE - Transfer to P&L Account
                    yearEntry.creditEntries.push({
                        date: entryDate,
                        particulars: 'By Profit & Loss A/c',
                        amount: year.depreciation,
                        type: 'transfer_pl'
                    });

                    yearEntry.debitTotal = year.depreciation;
                    yearEntry.creditTotal = year.depreciation;

                    entries.push(yearEntry);
                });

                schedule.depreciationAccountEntries = entries;
            },

            // Generate Profit/Loss on Sale entries
            generateProfitLossEntries(schedule, problem) {
                if (!problem.hasSale) return;

                const lastYear = schedule.years[schedule.years.length - 1];
                const bookValueAtSale = lastYear.openingBalance - lastYear.depreciation;
                const profitLoss = this.calculateProfitLoss(problem.salePrice, bookValueAtSale);

                schedule.profitLossEntries = {
                    salePrice: problem.salePrice,
                    bookValueAtSale: bookValueAtSale,
                    profitLoss: profitLoss,
                    saleDate: problem.saleDate,
                    assetName: problem.assetName
                };
            },

            // Format currency
            formatCurrency(amount) {
                return '₹' + amount.toLocaleString('en-IN');
            }
        };

        // ========== PROBLEM GENERATOR ==========
        const ProblemGenerator = {
            // Generate a random problem based on difficulty
            generateProblem(difficulty = 'medium') {
                const config = this.getDifficultyConfig(difficulty);
                
                // Select random asset type
                const assetTypeData = this.selectRandom(AssetData.assetTypes);
                const assetName = this.selectRandom(assetTypeData.names);
                
                // Generate purchase details
                const purchaseYear = this.randomInt(config.yearRange.min, config.yearRange.max);
                const purchaseDate = this.generatePurchaseDate(purchaseYear, config);
                
                // Generate purchase price (rounded to nice numbers)
                const purchasePrice = this.generateNiceNumber(config.priceRange.min, config.priceRange.max);
                
                // Additional cost (for medium and hard)
                let additionalCost = 0;
                let additionalCostDetails = null;
                if (config.hasAdditionalCost && Math.random() < config.additionalCostChance) {
                    const costType = this.selectRandom(AssetData.additionalCosts);
                    const percent = this.randomInt(costType.minPercent, costType.maxPercent);
                    additionalCost = Math.round(purchasePrice * percent / 100);
                    additionalCost = this.roundToNice(additionalCost);
                    additionalCostDetails = {
                        name: costType.name,
                        amount: additionalCost
                    };
                }
                
                // Depreciation rate
                const depreciationRate = this.selectRandom(assetTypeData.typicalRates);
                
                // Number of years
                const numberOfYears = this.randomInt(config.yearsRange.min, config.yearsRange.max);
                
                // Purchase source
                const purchaseSource = this.selectRandom(AssetData.purchaseSources);
                
                // Sale details (for medium and hard)
                let hasSale = false;
                let saleDate = null;
                let salePrice = 0;
                let saleDestination = null;
                
                if (config.hasSale && Math.random() < config.saleChance) {
                    hasSale = true;
                    saleDate = this.generateSaleDate(purchaseDate, numberOfYears, config);
                    
                    // Calculate book value at sale and determine sale price
                    const totalCost = purchasePrice + additionalCost;
                    const annualDep = CalculationEngine.calculateSLMDepreciation(totalCost, depreciationRate);
                    
                    // Rough calculation of book value
                    const yearsOfDepreciation = numberOfYears - 1 + 
                        (DateUtils.calculateSaleYearMonths(saleDate.month, saleDate.day) / 12);
                    const estimatedBookValue = Math.max(
                        totalCost - Math.round(annualDep * yearsOfDepreciation),
                        0
                    );
                    
                    // Sale price: sometimes profit, sometimes loss
                    const saleFactor = config.salePriceRange.min + 
                        Math.random() * (config.salePriceRange.max - config.salePriceRange.min);
                    salePrice = this.roundToNice(Math.round(estimatedBookValue * saleFactor));
                    salePrice = Math.max(salePrice, 100); // Minimum sale price
                    
                    saleDestination = this.selectRandom(AssetData.saleDestinations);
                }

                const problem = {
                    id: Date.now(),
                    difficulty,
                    assetType: assetTypeData.type,
                    assetName,
                    accountName: assetTypeData.accountName.replace(assetTypeData.type, assetName),
                    purchaseDate,
                    purchasePrice,
                    additionalCost,
                    additionalCostDetails,
                    purchaseSource,
                    depreciationRate,
                    numberOfYears,
                    hasSale,
                    saleDate,
                    salePrice,
                    saleDestination,
                    method: 'Straight Line Method (SLM)'
                };

                // Generate the correct answers (depreciation schedule)
                problem.schedule = CalculationEngine.generateDepreciationSchedule(problem);

                return problem;
            },

            // Get configuration based on difficulty
            getDifficultyConfig(difficulty) {
                const configs = {
                    easy: {
                        yearRange: { min: 2020, max: 2023 },
                        priceRange: { min: 10000, max: 50000 },
                        yearsRange: { min: 2, max: 3 },
                        hasAdditionalCost: false,
                        additionalCostChance: 0,
                        hasSale: false,
                        saleChance: 0,
                        salePriceRange: { min: 0.7, max: 1.1 },
                        purchaseOnFirstApril: true // Purchase on April 1 for easy
                    },
                    medium: {
                        yearRange: { min: 2018, max: 2022 },
                        priceRange: { min: 20000, max: 100000 },
                        yearsRange: { min: 3, max: 4 },
                        hasAdditionalCost: true,
                        additionalCostChance: 0.5,
                        hasSale: true,
                        saleChance: 0.6,
                        salePriceRange: { min: 0.6, max: 1.2 },
                        purchaseOnFirstApril: false
                    },
                    hard: {
                        yearRange: { min: 2015, max: 2021 },
                        priceRange: { min: 50000, max: 200000 },
                        yearsRange: { min: 4, max: 5 },
                        hasAdditionalCost: true,
                        additionalCostChance: 0.7,
                        hasSale: true,
                        saleChance: 0.8,
                        salePriceRange: { min: 0.5, max: 1.3 },
                        purchaseOnFirstApril: false
                    }
                };
                return configs[difficulty] || configs.medium;
            },

            // Generate purchase date
            generatePurchaseDate(year, config) {
                if (config.purchaseOnFirstApril) {
                    return { year, month: 4, day: 1 };
                }
                
                // Random month (prefer financial year start months for easier calculations)
                const preferredMonths = [4, 7, 10, 1]; // Apr, Jul, Oct, Jan
                const allMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
                
                let month;
                if (Math.random() < 0.6) {
                    month = this.selectRandom(preferredMonths);
                } else {
                    month = this.selectRandom(allMonths);
                }
                
                // Prefer 1st of month for easier calculation, sometimes other dates
                let day;
                if (Math.random() < 0.5) {
                    day = 1;
                } else {
                    const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                    day = this.randomInt(1, daysInMonth[month - 1]);
                }
                
                return { year, month, day };
            },

            // Generate sale date
            generateSaleDate(purchaseDate, numberOfYears, config) {
                // Sale happens in the last year
                let saleYear;
                const purchaseFYStart = purchaseDate.month >= 4 ? purchaseDate.year : purchaseDate.year - 1;
                const lastFYStart = purchaseFYStart + numberOfYears - 1;
                
                // Sale can be in any month of the last financial year
                const saleMonthOptions = [4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3];
                const saleMonth = this.selectRandom(saleMonthOptions);
                
                if (saleMonth >= 4) {
                    saleYear = lastFYStart;
                } else {
                    saleYear = lastFYStart + 1;
                }
                
                const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                const saleDay = this.randomInt(1, daysInMonth[saleMonth - 1]);
                
                return { year: saleYear, month: saleMonth, day: saleDay };
            },

            // Helper: Select random from array
            selectRandom(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            },

            // Helper: Random integer
            randomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            },

            // Helper: Generate nice round number
            generateNiceNumber(min, max) {
                const base = this.randomInt(min / 1000, max / 1000) * 1000;
                const options = [0, 500, 250, 750];
                const addition = this.selectRandom(options);
                return base + addition;
            },

            // Helper: Round to nice number
            roundToNice(num) {
                if (num < 1000) {
                    return Math.round(num / 50) * 50;
                } else if (num < 10000) {
                    return Math.round(num / 100) * 100;
                } else {
                    return Math.round(num / 500) * 500;
                }
            }
        };

        // ========== PROBLEM QUESTION TEXT GENERATOR ==========
        const QuestionGenerator = {
            generateQuestionText(problem) {
                const {
                    assetName,
                    purchaseDate,
                    purchasePrice,
                    additionalCost,
                    additionalCostDetails,
                    purchaseSource,
                    depreciationRate,
                    numberOfYears,
                    hasSale,
                    saleDate,
                    salePrice,
                    method
                } = problem;

                let questionParts = [];

                // Opening statement
                const purchaseDateStr = DateUtils.formatDateShort(
                    purchaseDate.year, 
                    purchaseDate.month, 
                    purchaseDate.day
                );

                let priceStatement;
                if (additionalCost > 0 && additionalCostDetails) {
                    priceStatement = `On <span class="highlight">${purchaseDateStr}</span>, a ${assetName.toLowerCase()} was purchased for <span class="highlight">₹${purchasePrice.toLocaleString('en-IN')}</span>. ${additionalCostDetails.name} of <span class="highlight">₹${additionalCost.toLocaleString('en-IN')}</span> were also paid.`;
                } else {
                    priceStatement = `On <span class="highlight">${purchaseDateStr}</span>, a ${assetName.toLowerCase()} was purchased for <span class="highlight">₹${purchasePrice.toLocaleString('en-IN')}</span>.`;
                }
                questionParts.push(priceStatement);

                // Depreciation method and rate
                questionParts.push(`Depreciation is to be charged at <span class="highlight">${depreciationRate}% per annum</span> using the <span class="highlight">${method}</span>.`);

                // Books closing date
                questionParts.push(`Books are closed on <span class="highlight">31st March</span> every year.`);

                // Sale information if applicable
                if (hasSale && saleDate && salePrice) {
                    const saleDateStr = DateUtils.formatDateShort(
                        saleDate.year,
                        saleDate.month,
                        saleDate.day
                    );
                    questionParts.push(`The ${assetName.toLowerCase()} was sold on <span class="highlight">${saleDateStr}</span> for <span class="highlight">₹${salePrice.toLocaleString('en-IN')}</span>.`);
                }

                // Task
                const fyEndYear = purchaseDate.month >= 4 ? purchaseDate.year + numberOfYears : purchaseDate.year + numberOfYears - 1;
                let taskStatement = `<strong>Prepare the ${assetName} Account`;
                
                if (hasSale) {
                    taskStatement += ` and Depreciation Account for all relevant years.</strong>`;
                } else {
                    taskStatement += ` for ${numberOfYears} years and also show the Depreciation Account.</strong>`;
                }
                questionParts.push(taskStatement);

                return questionParts.map(p => `<p>${p}</p>`).join('');
            },

            generateProblemDetails(problem) {
                const details = [
                    {
                        icon: '🏭',
                        label: 'Asset Type',
                        value: problem.assetName
                    },
                    {
                        icon: '💰',
                        label: 'Purchase Price',
                        value: `₹${problem.purchasePrice.toLocaleString('en-IN')}`
                    },
                    {
                        icon: '📅',
                        label: 'Purchase Date',
                        value: DateUtils.formatDateShort(
                            problem.purchaseDate.year,
                            problem.purchaseDate.month,
                            problem.purchaseDate.day
                        )
                    },
                    {
                        icon: '📊',
                        label: 'Depreciation Rate',
                        value: `${problem.depreciationRate}% p.a.`
                    },
                    {
                        icon: '📈',
                        label: 'Method',
                        value: 'Straight Line Method'
                    },
                    {
                        icon: '📆',
                        label: 'Duration',
                        value: `${problem.numberOfYears} Years`
                    }
                ];

                if (problem.additionalCost > 0 && problem.additionalCostDetails) {
                    details.splice(2, 0, {
                        icon: '➕',
                        label: problem.additionalCostDetails.name,
                        value: `₹${problem.additionalCost.toLocaleString('en-IN')}`
                    });
                }

                if (problem.hasSale) {
                    details.push({
                        icon: '🏷️',
                        label: 'Sale Price',
                        value: `₹${problem.salePrice.toLocaleString('en-IN')}`
                    });
                    details.push({
                        icon: '📅',
                        label: 'Sale Date',
                        value: DateUtils.formatDateShort(
                            problem.saleDate.year,
                            problem.saleDate.month,
                            problem.saleDate.day
                        )
                    });
                }

                return details;
            }
        };

        // ========== CONSOLE LOG FOR TESTING ==========
        console.log('Part 3 Loaded: Data Structures & Problem Generation');
        console.log('Available modules: AppState, AssetData, DateUtils, CalculationEngine, ProblemGenerator, QuestionGenerator');
        
        // Test problem generation
        const testProblem = ProblemGenerator.generateProblem('medium');
        console.log('Sample Problem Generated:', testProblem);
        
        /* ========================================================
           DEPRECIATION PRACTICE APPLICATION
           Part 4: UI Rendering Functions
           ======================================================== */

        // ========== UI RENDERER ==========
        const UIRenderer = {
            // Initialize particles for background animation
            initParticles() {
                const container = document.getElementById('particles-container');
                if (!container) return;

                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c'];
                
                for (let i = 0; i < 20; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.cssText = `
                        left: ${Math.random() * 100}%;
                        top: ${Math.random() * 100}%;
                        width: ${Math.random() * 10 + 5}px;
                        height: ${Math.random() * 10 + 5}px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        animation-delay: ${Math.random() * 15}s;
                        animation-duration: ${15 + Math.random() * 10}s;
                    `;
                    container.appendChild(particle);
                }
            },

            // Render problem card
            renderProblemCard(problem) {
                const problemCard = document.getElementById('problemCard');
                const problemNumber = document.getElementById('problemNumber');
                const problemTitleText = document.getElementById('problemTitleText');
                const difficultyBadge = document.getElementById('difficultyBadge');
                const problemDetails = document.getElementById('problemDetails');
                const problemQuestion = document.getElementById('problemQuestion');

                // Update problem number
                AppState.problemCount++;
                problemNumber.textContent = AppState.problemCount;
                problemTitleText.textContent = `${problem.assetName} - Depreciation Problem`;

                // Update difficulty badge
                difficultyBadge.textContent = problem.difficulty.charAt(0).toUpperCase() + problem.difficulty.slice(1);
                difficultyBadge.className = `difficulty-badge difficulty-${problem.difficulty}`;

                // Render problem details
                const details = QuestionGenerator.generateProblemDetails(problem);
                problemDetails.innerHTML = details.map(detail => `
                    <div class="detail-item">
                        <div class="detail-icon">${detail.icon}</div>
                        <div class="detail-content">
                            <div class="detail-label">${detail.label}</div>
                            <div class="detail-value">${detail.value}</div>
                        </div>
                    </div>
                `).join('');

                // Render question text
                problemQuestion.innerHTML = QuestionGenerator.generateQuestionText(problem);

                // Show problem card with animation
                problemCard.style.display = 'block';
                problemCard.style.animation = 'none';
                problemCard.offsetHeight; // Trigger reflow
                problemCard.style.animation = 'slideUp 0.6s ease-out';
            },

            // Render Asset Account Table
            renderAssetAccountTable(problem) {
                const section = document.getElementById('assetAccountSection');
                const title = document.getElementById('assetAccountTitle');
                const tbody = document.getElementById('assetAccountBody');

                // Set account title
                title.textContent = `${problem.assetName} Account`;

                // Clear existing content
                tbody.innerHTML = '';

                const { assetAccountEntries } = problem.schedule;
                let inputIndex = 0;

                // Store correct answers for this table
                AppState.correctAnswers.assetAccount = {};

                assetAccountEntries.forEach((yearEntry, yearIndex) => {
                    // Calculate max rows needed for this year
                    const maxRows = Math.max(
                        yearEntry.debitEntries.length,
                        yearEntry.creditEntries.length
                    );

                    // Add year separator if not first year
                    if (yearIndex > 0) {
                        const separatorRow = document.createElement('tr');
                        separatorRow.className = 'year-separator';
                        separatorRow.innerHTML = `<td colspan="6"></td>`;
                        tbody.appendChild(separatorRow);
                    }

                    // Create rows for this year
                    for (let rowIndex = 0; rowIndex < maxRows; rowIndex++) {
                        const row = document.createElement('tr');
                        
                        const debitEntry = yearEntry.debitEntries[rowIndex];
                        const creditEntry = yearEntry.creditEntries[rowIndex];

                        // DEBIT SIDE
                        if (debitEntry) {
                            const dateCell = document.createElement('td');
                            dateCell.className = 'date-cell';
                            dateCell.textContent = debitEntry.date;
                            row.appendChild(dateCell);

                            const particularCell = document.createElement('td');
                            particularCell.className = 'particulars-cell';
                            
                            // For some entries, show particulars; for amounts, create input
                            if (debitEntry.type === 'purchase' || debitEntry.type === 'profit') {
                                particularCell.textContent = debitEntry.particulars;
                            } else {
                                particularCell.textContent = debitEntry.particulars;
                            }
                            row.appendChild(particularCell);

                            const amountCell = document.createElement('td');
                            amountCell.className = 'amount-cell input-cell';
                            const inputId = `asset_dr_${yearIndex}_${rowIndex}`;
                            amountCell.innerHTML = `
                                <input type="text" 
                                       class="table-input" 
                                       id="${inputId}"
                                       data-table="assetAccount"
                                       data-side="debit"
                                       data-year="${yearIndex}"
                                       data-row="${rowIndex}"
                                       data-type="${debitEntry.type}"
                                       placeholder="₹ Amount"
                                       autocomplete="off">
                                <span class="validation-icon"></span>
                                <div class="correct-answer" id="${inputId}_correct"></div>
                            `;
                            row.appendChild(amountCell);

                            // Store correct answer
                            AppState.correctAnswers.assetAccount[inputId] = debitEntry.amount;
                        } else {
                            // Empty cells
                            row.appendChild(this.createEmptyCell('date-cell'));
                            row.appendChild(this.createEmptyCell('particulars-cell'));
                            row.appendChild(this.createEmptyCell('amount-cell'));
                        }

                        // CREDIT SIDE
                        if (creditEntry) {
                            const dateCell = document.createElement('td');
                            dateCell.className = 'date-cell';
                            dateCell.textContent = creditEntry.date;
                            row.appendChild(dateCell);

                            const particularCell = document.createElement('td');
                            particularCell.className = 'particulars-cell';
                            particularCell.textContent = creditEntry.particulars;
                            row.appendChild(particularCell);

                            const amountCell = document.createElement('td');
                            amountCell.className = 'amount-cell input-cell';
                            const inputId = `asset_cr_${yearIndex}_${rowIndex}`;
                            amountCell.innerHTML = `
                                <input type="text" 
                                       class="table-input" 
                                       id="${inputId}"
                                       data-table="assetAccount"
                                       data-side="credit"
                                       data-year="${yearIndex}"
                                       data-row="${rowIndex}"
                                       data-type="${creditEntry.type}"
                                       placeholder="₹ Amount"
                                       autocomplete="off">
                                <span class="validation-icon"></span>
                                <div class="correct-answer" id="${inputId}_correct"></div>
                            `;
                            row.appendChild(amountCell);

                            // Store correct answer
                            AppState.correctAnswers.assetAccount[inputId] = creditEntry.amount;
                        } else {
                            // Empty cells
                            row.appendChild(this.createEmptyCell('date-cell'));
                            row.appendChild(this.createEmptyCell('particulars-cell'));
                            row.appendChild(this.createEmptyCell('amount-cell'));
                        }

                        tbody.appendChild(row);
                    }

                    // Add total row for this year
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    
                    // Debit total
                    totalRow.appendChild(this.createEmptyCell('date-cell'));
                    const debitTotalLabel = document.createElement('td');
                    debitTotalLabel.className = 'particulars-cell';
                    debitTotalLabel.innerHTML = '<strong>Total</strong>';
                    totalRow.appendChild(debitTotalLabel);
                    
                    const debitTotalCell = document.createElement('td');
                    debitTotalCell.className = 'amount-cell input-cell';
                    const debitTotalId = `asset_dr_total_${yearIndex}`;
                    debitTotalCell.innerHTML = `
                        <input type="text" 
                               class="table-input" 
                               id="${debitTotalId}"
                               data-table="assetAccount"
                               data-side="debit"
                               data-year="${yearIndex}"
                               data-type="total"
                               placeholder="₹ Total"
                               autocomplete="off">
                        <span class="validation-icon"></span>
                        <div class="correct-answer" id="${debitTotalId}_correct"></div>
                    `;
                    totalRow.appendChild(debitTotalCell);
                    AppState.correctAnswers.assetAccount[debitTotalId] = yearEntry.debitTotal;

                    // Credit total
                    totalRow.appendChild(this.createEmptyCell('date-cell'));
                    const creditTotalLabel = document.createElement('td');
                    creditTotalLabel.className = 'particulars-cell';
                    creditTotalLabel.innerHTML = '<strong>Total</strong>';
                    totalRow.appendChild(creditTotalLabel);
                    
                    const creditTotalCell = document.createElement('td');
                    creditTotalCell.className = 'amount-cell input-cell';
                    const creditTotalId = `asset_cr_total_${yearIndex}`;
                    creditTotalCell.innerHTML = `
                        <input type="text" 
                               class="table-input" 
                               id="${creditTotalId}"
                               data-table="assetAccount"
                               data-side="credit"
                               data-year="${yearIndex}"
                               data-type="total"
                               placeholder="₹ Total"
                               autocomplete="off">
                        <span class="validation-icon"></span>
                        <div class="correct-answer" id="${creditTotalId}_correct"></div>
                    `;
                    totalRow.appendChild(creditTotalCell);
                    AppState.correctAnswers.assetAccount[creditTotalId] = yearEntry.creditTotal;

                    tbody.appendChild(totalRow);
                });

                // Show section with animation
                section.style.display = 'block';
                section.style.animation = 'none';
                section.offsetHeight;
                section.style.animation = 'slideUp 0.6s ease-out 0.2s both';
            },

            // Render Depreciation Account Table
            renderDepreciationAccountTable(problem) {
                const section = document.getElementById('depreciationAccountSection');
                const tbody = document.getElementById('depreciationAccountBody');

                // Clear existing content
                tbody.innerHTML = '';

                const { depreciationAccountEntries } = problem.schedule;

                // Store correct answers for this table
                AppState.correctAnswers.depreciationAccount = {};

                depreciationAccountEntries.forEach((yearEntry, yearIndex) => {
                    // Add year separator if not first year
                    if (yearIndex > 0) {
                        const separatorRow = document.createElement('tr');
                        separatorRow.className = 'year-separator';
                        separatorRow.innerHTML = `<td colspan="6"></td>`;
                        tbody.appendChild(separatorRow);
                    }

                    const maxRows = Math.max(
                        yearEntry.debitEntries.length,
                        yearEntry.creditEntries.length
                    );

                    for (let rowIndex = 0; rowIndex < maxRows; rowIndex++) {
                        const row = document.createElement('tr');
                        
                        const debitEntry = yearEntry.debitEntries[rowIndex];
                        const creditEntry = yearEntry.creditEntries[rowIndex];

                        // DEBIT SIDE
                        if (debitEntry) {
                            const dateCell = document.createElement('td');
                            dateCell.className = 'date-cell';
                            dateCell.textContent = debitEntry.date;
                            row.appendChild(dateCell);

                            const particularCell = document.createElement('td');
                            particularCell.className = 'particulars-cell';
                            particularCell.textContent = debitEntry.particulars;
                            row.appendChild(particularCell);

                            const amountCell = document.createElement('td');
                            amountCell.className = 'amount-cell input-cell';
                            const inputId = `dep_dr_${yearIndex}_${rowIndex}`;
                            amountCell.innerHTML = `
                                <input type="text" 
                                       class="table-input" 
                                       id="${inputId}"
                                       data-table="depreciationAccount"
                                       data-side="debit"
                                       data-year="${yearIndex}"
                                       data-row="${rowIndex}"
                                       placeholder="₹ Amount"
                                       autocomplete="off">
                                <span class="validation-icon"></span>
                                <div class="correct-answer" id="${inputId}_correct"></div>
                            `;
                            row.appendChild(amountCell);

                            AppState.correctAnswers.depreciationAccount[inputId] = debitEntry.amount;
                        } else {
                            row.appendChild(this.createEmptyCell('date-cell'));
                            row.appendChild(this.createEmptyCell('particulars-cell'));
                            row.appendChild(this.createEmptyCell('amount-cell'));
                        }

                        // CREDIT SIDE
                        if (creditEntry) {
                            const dateCell = document.createElement('td');
                            dateCell.className = 'date-cell';
                            dateCell.textContent = creditEntry.date;
                            row.appendChild(dateCell);

                            const particularCell = document.createElement('td');
                            particularCell.className = 'particulars-cell';
                            particularCell.textContent = creditEntry.particulars;
                            row.appendChild(particularCell);

                            const amountCell = document.createElement('td');
                            amountCell.className = 'amount-cell input-cell';
                            const inputId = `dep_cr_${yearIndex}_${rowIndex}`;
                            amountCell.innerHTML = `
                                <input type="text" 
                                       class="table-input" 
                                       id="${inputId}"
                                       data-table="depreciationAccount"
                                       data-side="credit"
                                       data-year="${yearIndex}"
                                       data-row="${rowIndex}"
                                       placeholder="₹ Amount"
                                       autocomplete="off">
                                <span class="validation-icon"></span>
                                <div class="correct-answer" id="${inputId}_correct"></div>
                            `;
                            row.appendChild(amountCell);

                            AppState.correctAnswers.depreciationAccount[inputId] = creditEntry.amount;
                        } else {
                            row.appendChild(this.createEmptyCell('date-cell'));
                            row.appendChild(this.createEmptyCell('particulars-cell'));
                            row.appendChild(this.createEmptyCell('amount-cell'));
                        }

                        tbody.appendChild(row);
                    }

                    // Add total row
                    const totalRow = document.createElement('tr');
                    totalRow.className = 'total-row';
                    
                    // Debit total
                    totalRow.appendChild(this.createEmptyCell('date-cell'));
                    const debitTotalLabel = document.createElement('td');
                    debitTotalLabel.className = 'particulars-cell';
                    debitTotalLabel.innerHTML = '<strong>Total</strong>';
                    totalRow.appendChild(debitTotalLabel);
                    
                    const debitTotalCell = document.createElement('td');
                    debitTotalCell.className = 'amount-cell input-cell';
                    const debitTotalId = `dep_dr_total_${yearIndex}`;
                    debitTotalCell.innerHTML = `
                        <input type="text" 
                               class="table-input" 
                               id="${debitTotalId}"
                               data-table="depreciationAccount"
                               data-side="debit"
                               data-year="${yearIndex}"
                               data-type="total"
                               placeholder="₹ Total"
                               autocomplete="off">
                        <span class="validation-icon"></span>
                        <div class="correct-answer" id="${debitTotalId}_correct"></div>
                    `;
                    totalRow.appendChild(debitTotalCell);
                    AppState.correctAnswers.depreciationAccount[debitTotalId] = yearEntry.debitTotal;

                    // Credit total
                    totalRow.appendChild(this.createEmptyCell('date-cell'));
                    const creditTotalLabel = document.createElement('td');
                    creditTotalLabel.className = 'particulars-cell';
                    creditTotalLabel.innerHTML = '<strong>Total</strong>';
                    totalRow.appendChild(creditTotalLabel);
                    
                    const creditTotalCell = document.createElement('td');
                    creditTotalCell.className = 'amount-cell input-cell';
                    const creditTotalId = `dep_cr_total_${yearIndex}`;
                    creditTotalCell.innerHTML = `
                        <input type="text" 
                               class="table-input" 
                               id="${creditTotalId}"
                               data-table="depreciationAccount"
                               data-side="credit"
                               data-year="${yearIndex}"
                               data-type="total"
                               placeholder="₹ Total"
                               autocomplete="off">
                        <span class="validation-icon"></span>
                        <div class="correct-answer" id="${creditTotalId}_correct"></div>
                    `;
                    totalRow.appendChild(creditTotalCell);
                    AppState.correctAnswers.depreciationAccount[creditTotalId] = yearEntry.creditTotal;

                    tbody.appendChild(totalRow);
                });

                // Show section with animation
                section.style.display = 'block';
                section.style.animation = 'none';
                section.offsetHeight;
                section.style.animation = 'slideUp 0.6s ease-out 0.4s both';
            },

            // Render Profit/Loss on Sale Section
            renderProfitLossSection(problem) {
                const section = document.getElementById('profitLossSection');
                const title = document.getElementById('profitLossTitle');
                const tbody = document.getElementById('profitLossBody');

                if (!problem.hasSale || !problem.schedule.profitLossEntries) {
                    section.style.display = 'none';
                    return;
                }

                const { profitLossEntries } = problem.schedule;
                const { profitLoss, saleDate, assetName, salePrice, bookValueAtSale } = profitLossEntries;

                // Clear existing content
                tbody.innerHTML = '';

                // Store correct answers
                AppState.correctAnswers.profitLoss = {};

                // Set title based on profit or loss
                if (profitLoss.isProfit) {
                    title.textContent = 'Profit on Sale of ' + assetName;
                } else if (profitLoss.isLoss) {
                    title.textContent = 'Loss on Sale of ' + assetName;
                } else {
                    title.textContent = 'Sale of ' + assetName + ' (No Profit/Loss)';
                }

                const saleDateStr = DateUtils.formatDate(saleDate.year, saleDate.month, saleDate.day);

                if (profitLoss.isProfit) {
                    // Profit Case - Debit side shows Asset A/c (Book Value), Credit side shows Sale proceeds + Profit
                    const row1 = document.createElement('tr');
                    
                    // Debit: Book Value (from Asset A/c)
                    row1.innerHTML = `
                        <td class="date-cell">${saleDateStr}</td>
                        <td class="particulars-cell">To ${assetName} A/c (Book Value)</td>
                        <td class="amount-cell input-cell">
                            <input type="text" 
                                   class="table-input" 
                                   id="pl_dr_bookvalue"
                                   data-table="profitLoss"
                                   data-side="debit"
                                   data-type="bookvalue"
                                   placeholder="₹ Amount"
                                   autocomplete="off">
                            <span class="validation-icon"></span>
                            <div class="correct-answer" id="pl_dr_bookvalue_correct"></div>
                        </td>
                        <td class="date-cell">${saleDateStr}</td>
                        <td class="particulars-cell">By Bank A/c (Sale Proceeds)</td>
                        <td class="amount-cell input-cell">
                            <input type="text" 
                                   class="table-input" 
                                   id="pl_cr_sale"
                                   data-table="profitLoss"
                                   data-side="credit"
                                   data-type="sale"
                                   placeholder="₹ Amount"
                                   autocomplete="off">
                            <span class="validation-icon"></span>
                            <div class="correct-answer" id="pl_cr_sale_correct"></div>
                        </td>
                    `;
                    tbody.appendChild(row1);

                    AppState.correctAnswers.profitLoss['pl_dr_bookvalue'] = bookValueAtSale;
                    AppState.correctAnswers.profitLoss['pl_cr_sale'] = salePrice;

                    // Row 2: Profit to P&L
                    const row2 = document.createElement('tr');
                    row2.innerHTML = `
                        <td class="date-cell">${saleDateStr}</td>
                        <td class="particulars-cell">To Profit & Loss A/c (Profit)</td>
                        <td class="amount-cell input-cell">
                            <input type="text" 
                                   class="table-input" 
                                   id="pl_dr_profit"
                                   data-table="profitLoss"
                                   data-side="debit"
                                   data-type="profit"
                                   placeholder="₹ Amount"
                                   autocomplete="off">
                            <span class="validation-icon"></span>
                            <div class="correct-answer" id="pl_dr_profit_correct"></div>
                        </td>
                        <td class="date-cell"></td>
                        <td class="particulars-cell"></td>
                        <td class="amount-cell"></td>
                    `;
                    tbody.appendChild(row2);

                    AppState.correctAnswers.profitLoss['pl_dr_profit'] = profitLoss.amount;

                } else if (profitLoss.isLoss) {
                    // Loss Case - Debit side shows Sale proceeds, Credit side shows Book Value + Loss transfer
                    const row1 = document.createElement('tr');
                    
                    row1.innerHTML = `
                        <td class="date-cell">${saleDateStr}</td>
                        <td class="particulars-cell">To Bank A/c (Sale Proceeds)</td>
                        <td class="amount-cell input-cell">
                            <input type="text" 
                                   class="table-input" 
                                   id="pl_dr_sale"
                                   data-table="profitLoss"
                                   data-side="debit"
                                   data-type="sale"
                                   placeholder="₹ Amount"
                                   autocomplete="off">
                            <span class="validation-icon"></span>
                            <div class="correct-answer" id="pl_dr_sale_correct"></div>
                        </td>
                        <td class="date-cell">${saleDateStr}</td>
                        <td class="particulars-cell">By ${assetName} A/c (Book Value)</td>
                        <td class="amount-cell input-cell">
                            <input type="text" 
                                   class="table-input" 
                                   id="pl_cr_bookvalue"
                                   data-table="profitLoss"
                                   data-side="credit"
                                   data-type="bookvalue"
                                   placeholder="₹ Amount"
                                   autocomplete="off">
                            <span class="validation-icon"></span>
                            <div class="correct-answer" id="pl_cr_bookvalue_correct"></div>
                        </td>
                    `;
                    tbody.appendChild(row1);

                    AppState.correctAnswers.profitLoss['pl_dr_sale'] = salePrice;
                    AppState.correctAnswers.profitLoss['pl_cr_bookvalue'] = bookValueAtSale;

                    // Row 2: Loss to P&L
                    const row2 = document.createElement('tr');
                    row2.innerHTML = `
                        <td class="date-cell">${saleDateStr}</td>
                        <td class="particulars-cell">To Profit & Loss A/c (Loss)</td>
                        <td class="amount-cell input-cell">
                            <input type="text" 
                                   class="table-input" 
                                   id="pl_dr_loss"
                                   data-table="profitLoss"
                                   data-side="debit"
                                   data-type="loss"
                                   placeholder="₹ Amount"
                                   autocomplete="off">
                            <span class="validation-icon"></span>
                            <div class="correct-answer" id="pl_dr_loss_correct"></div>
                        </td>
                        <td class="date-cell"></td>
                        <td class="particulars-cell"></td>
                        <td class="amount-cell"></td>
                    `;
                    tbody.appendChild(row2);

                    AppState.correctAnswers.profitLoss['pl_dr_loss'] = profitLoss.amount;
                }

                // Add total row
                const totalRow = document.createElement('tr');
                totalRow.className = 'total-row';
                
                const debitTotal = profitLoss.isProfit ? 
                    bookValueAtSale + profitLoss.amount : 
                    salePrice + profitLoss.amount;
                const creditTotal = profitLoss.isProfit ? salePrice : bookValueAtSale;

                totalRow.innerHTML = `
                    <td class="date-cell"></td>
                    <td class="particulars-cell"><strong>Total</strong></td>
                    <td class="amount-cell input-cell">
                        <input type="text" 
                               class="table-input" 
                               id="pl_dr_total"
                               data-table="profitLoss"
                               data-side="debit"
                               data-type="total"
                               placeholder="₹ Total"
                               autocomplete="off">
                        <span class="validation-icon"></span>
                        <div class="correct-answer" id="pl_dr_total_correct"></div>
                    </td>
                    <td class="date-cell"></td>
                    <td class="particulars-cell"><strong>Total</strong></td>
                    <td class="amount-cell input-cell">
                        <input type="text" 
                               class="table-input" 
                               id="pl_cr_total"
                               data-table="profitLoss"
                               data-side="credit"
                               data-type="total"
                               placeholder="₹ Total"
                               autocomplete="off">
                        <span class="validation-icon"></span>
                        <div class="correct-answer" id="pl_cr_total_correct"></div>
                    </td>
                `;
                tbody.appendChild(totalRow);

                AppState.correctAnswers.profitLoss['pl_dr_total'] = debitTotal;
                AppState.correctAnswers.profitLoss['pl_cr_total'] = creditTotal;

                // Show section
                section.style.display = 'block';
                section.style.animation = 'none';
                section.offsetHeight;
                section.style.animation = 'slideUp 0.6s ease-out 0.6s both';
            },

            // Helper: Create empty cell
            createEmptyCell(className) {
                const cell = document.createElement('td');
                cell.className = className;
                return cell;
            },

            // Render Results Section
            renderResults(results) {
                const section = document.getElementById('resultsSection');
                
                const percentage = Math.round((results.correctCount / results.totalCount) * 100);
                let resultClass, resultTitle, resultEmoji;

                if (percentage >= 90) {
                    resultClass = 'excellent';
                    resultTitle = 'Excellent Work!';
                    resultEmoji = '🏆';
                } else if (percentage >= 70) {
                    resultClass = 'good';
                    resultTitle = 'Good Job!';
                    resultEmoji = '👍';
                } else if (percentage >= 50) {
                    resultClass = 'average';
                    resultTitle = 'Keep Practicing!';
                    resultEmoji = '📚';
                } else {
                    resultClass = 'needs-improvement';
                    resultTitle = 'Needs Improvement';
                    resultEmoji = '💪';
                }

                // Calculate stroke dashoffset for circle animation
                const circumference = 2 * Math.PI * 65; // radius = 65
                const offset = circumference - (percentage / 100) * circumference;

                section.innerHTML = `
                    <div class="results-header">
                        <h2 class="results-title ${resultClass}">${resultEmoji} ${resultTitle}</h2>
                    </div>

                    <div class="score-display">
                        <div class="score-circle">
                            <svg viewBox="0 0 150 150">
                                <defs>
                                    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#667eea"/>
                                        <stop offset="100%" style="stop-color:#764ba2"/>
                                    </linearGradient>
                                </defs>
                                <circle class="bg-circle" cx="75" cy="75" r="65"/>
                                <circle class="progress-circle" cx="75" cy="75" r="65" 
                                        style="stroke-dashoffset: ${offset}"/>
                            </svg>
                            <div class="score-text">
                                <div class="score-percentage">${percentage}%</div>
                                <div class="score-label">Score</div>
                            </div>
                        </div>

                        <div class="score-details">
                            <div class="score-detail-item">
                                <div class="score-detail-icon correct">✓</div>
                                <div class="score-detail-info">
                                    <div class="score-detail-value">${results.correctCount}</div>
                                    <div class="score-detail-label">Correct Answers</div>
                                </div>
                            </div>
                            <div class="score-detail-item">
                                <div class="score-detail-icon incorrect">✗</div>
                                <div class="score-detail-info">
                                    <div class="score-detail-value">${results.incorrectCount}</div>
                                    <div class="score-detail-label">Incorrect Answers</div>
                                </div>
                            </div>
                            <div class="score-detail-item">
                                <div class="score-detail-icon total">Σ</div>
                                <div class="score-detail-info">
                                    <div class="score-detail-value">${results.totalCount}</div>
                                    <div class="score-detail-label">Total Fields</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feedback-section">
                        <h3 class="feedback-title">📋 Detailed Feedback</h3>
                        <div class="feedback-list">
                            ${results.feedback.map(item => `
                                <div class="feedback-item ${item.isCorrect ? 'correct' : 'incorrect'}">
                                    <div class="feedback-icon">${item.isCorrect ? '✓' : '✗'}</div>
                                    <div class="feedback-content">
                                        <div class="feedback-field">${item.field}</div>
                                        <div class="feedback-message">${item.message}</div>
                                        ${!item.isCorrect ? `
                                            <div class="feedback-values">
                                                <span class="feedback-your-answer">Your answer: ₹${item.userAnswer || 'Not entered'}</span>
                                                <span class="feedback-correct-answer">Correct: ₹${item.correctAnswer.toLocaleString('en-IN')}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="App.generateNewProblem()">
                            🎲 Try Another Problem
                        </button>
                        <button class="btn btn-secondary" onclick="App.resetCurrentProblem()">
                            🔄 Retry This Problem
                        </button>
                    </div>
                `;

                section.style.display = 'block';
                section.style.animation = 'none';
                section.offsetHeight;
                section.style.animation = 'slideUp 0.6s ease-out';

                // Trigger confetti for excellent scores
                if (percentage >= 90) {
                    this.triggerConfetti();
                }
            },

            // Update statistics display
            updateStats() {
                document.getElementById('problemsAttempted').textContent = AppState.stats.problemsAttempted;
                document.getElementById('correctAnswers').textContent = AppState.stats.correctFields;
                
                const accuracy = AppState.stats.totalFields > 0 
                    ? Math.round((AppState.stats.correctFields / AppState.stats.totalFields) * 100)
                    : 0;
                document.getElementById('accuracyRate').textContent = accuracy + '%';
                document.getElementById('currentStreak').textContent = AppState.stats.currentStreak;
            },

            // Trigger confetti animation
            triggerConfetti() {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#00d26a', '#ffa502'];
                const confettiContainer = document.createElement('div');
                confettiContainer.className = 'confetti';
                confettiContainer.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;';
                document.body.appendChild(confettiContainer);

                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti-piece';
                    confetti.style.cssText = `
                        left: ${Math.random() * 100}%;
                        top: -10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        animation-delay: ${Math.random() * 2}s;
                        transform: rotate(${Math.random() * 360}deg);
                    `;
                    confettiContainer.appendChild(confetti);
                }

                setTimeout(() => confettiContainer.remove(), 5000);
            },

            // Show toast notification
            showToast(type, title, message) {
                let container = document.querySelector('.toast-container');
                if (!container) {
                    container = document.createElement('div');
                    container.className = 'toast-container';
                    document.body.appendChild(container);
                }

                const icons = {
                    success: '✓',
                    error: '✗',
                    warning: '⚠',
                    info: 'ℹ'
                };

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close">&times;</button>
                `;

                container.appendChild(toast);

                // Trigger animation
                setTimeout(() => toast.classList.add('show'), 10);

                // Close button
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                });

                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            },

            // Hide all sections
            hideAllSections() {
                document.getElementById('problemCard').style.display = 'none';
                document.getElementById('assetAccountSection').style.display = 'none';
                document.getElementById('depreciationAccountSection').style.display = 'none';
                document.getElementById('profitLossSection').style.display = 'none';
                document.getElementById('resultsSection').style.display = 'none';
            },

            // Render empty state
            renderEmptyState() {
                this.hideAllSections();

                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.id = 'emptyState';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">📊</div>
                    <h3 class="empty-state-title">Ready to Practice?</h3>
                    <p class="empty-state-text">
                        Click "New Problem" to generate a depreciation accounting problem. 
                        You'll practice preparing Asset Account and Depreciation Account in T-format.
                    </p>
                    <button class="btn btn-primary" onclick="App.generateNewProblem()">
                        🎲 Generate Problem
                    </button>
                `;

                const container = document.querySelector('.main-container');
                const existingEmpty = document.getElementById('emptyState');
                if (existingEmpty) {
                    existingEmpty.remove();
                }
                container.appendChild(emptyState);
            },

            // Remove empty state
            removeEmptyState() {
                const emptyState = document.getElementById('emptyState');
                if (emptyState) {
                    emptyState.remove();
                }
            }
        };

        // ========== INPUT HANDLER ==========
        const InputHandler = {
            // Initialize input event listeners
            init() {
                // Delegate input events to document
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('table-input')) {
                        this.handleInput(e.target);
                    }
                });

                // Handle keydown for navigation
                document.addEventListener('keydown', (e) => {
                    if (e.target.classList.contains('table-input')) {
                        this.handleKeydown(e);
                    }
                });

                // Handle focus for visual feedback
                document.addEventListener('focus', (e) => {
                    if (e.target.classList.contains('table-input')) {
                        this.handleFocus(e.target);
                    }
                }, true);

                // Handle blur
                document.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('table-input')) {
                        this.handleBlur(e.target);
                    }
                }, true);
            },

            // Handle input changes
            handleInput(input) {
                // Remove non-numeric characters except for decimal
                let value = input.value.replace(/[^0-9.]/g, '');
                
                // Ensure only one decimal point
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                input.value = value;

                // Store user answer
                const inputId = input.id;
                if (!AppState.userAnswers[input.dataset.table]) {
                    AppState.userAnswers[input.dataset.table] = {};
                }
                AppState.userAnswers[input.dataset.table][inputId] = parseFloat(value) || 0;

                // Enable check button if at least one input has value
                this.updateCheckButtonState();
            },

            // Handle keyboard navigation
            handleKeydown(e) {
                const inputs = Array.from(document.querySelectorAll('.table-input'));
                const currentIndex = inputs.indexOf(e.target);

                switch(e.key) {
                    case 'Enter':
                    case 'Tab':
                        if (!e.shiftKey) {
                            e.preventDefault();
                            const nextInput = inputs[currentIndex + 1];
                            if (nextInput) nextInput.focus();
                        }
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        // Find next input in same column
                        const nextDown = inputs[currentIndex + 2];
                        if (nextDown) nextDown.focus();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        const nextUp = inputs[currentIndex - 2];
                        if (nextUp) nextUp.focus();
                        break;
                }
            },

            // Handle focus
            handleFocus(input) {
                input.parentElement.classList.add('focused');
            },

            // Handle blur
            handleBlur(input) {
                input.parentElement.classList.remove('focused');
                
                // Format number with commas
                if (input.value) {
                    const num = parseFloat(input.value);
                    if (!isNaN(num)) {
                        // Keep raw value for comparison, display formatted
                        input.dataset.rawValue = num;
                    }
                }
            },

            // Update check button state
            updateCheckButtonState() {
                const inputs = document.querySelectorAll('.table-input');
                let hasValue = false;
                
                inputs.forEach(input => {
                    if (input.value.trim()) {
                        hasValue = true;
                    }
                });

                document.getElementById('checkAnswersBtn').disabled = !hasValue;
                document.getElementById('resetBtn').disabled = !hasValue;
            },

            // Clear all inputs
            clearAllInputs() {
                const inputs = document.querySelectorAll('.table-input');
                inputs.forEach(input => {
                    input.value = '';
                    input.classList.remove('correct', 'incorrect');
                    input.parentElement.classList.remove('validated', 'correct', 'incorrect');
                    
                    const correctDiv = document.getElementById(input.id + '_correct');
                    if (correctDiv) {
                        correctDiv.classList.remove('show');
                        correctDiv.textContent = '';
                    }
                });

                AppState.userAnswers = {};
                AppState.isChecked = false;

                // Hide results section
                document.getElementById('resultsSection').style.display = 'none';
            }
        };

        // Console log for testing
        console.log('Part 4 Loaded: UI Rendering Functions');
        console.log('Available modules: UIRenderer, InputHandler');
        
        /* ========================================================
           DEPRECIATION PRACTICE APPLICATION
           Part 5: Answer Checking, Validation, Hints, Timer & Solution
           ======================================================== */

        // ========== ANSWER VALIDATOR ==========
        const AnswerValidator = {
            // Tolerance for rounding differences
            tolerance: 2,

            // Validate all answers
            validateAllAnswers() {
                const results = {
                    correctCount: 0,
                    incorrectCount: 0,
                    totalCount: 0,
                    feedback: [],
                    details: {}
                };

                // Validate Asset Account
                if (AppState.correctAnswers.assetAccount) {
                    const assetResults = this.validateTable('assetAccount', 'Asset Account');
                    results.correctCount += assetResults.correct;
                    results.incorrectCount += assetResults.incorrect;
                    results.totalCount += assetResults.total;
                    results.feedback.push(...assetResults.feedback);
                    results.details.assetAccount = assetResults;
                }

                // Validate Depreciation Account
                if (AppState.correctAnswers.depreciationAccount) {
                    const depResults = this.validateTable('depreciationAccount', 'Depreciation Account');
                    results.correctCount += depResults.correct;
                    results.incorrectCount += depResults.incorrect;
                    results.totalCount += depResults.total;
                    results.feedback.push(...depResults.feedback);
                    results.details.depreciationAccount = depResults;
                }

                // Validate Profit/Loss (if applicable)
                if (AppState.correctAnswers.profitLoss) {
                    const plResults = this.validateTable('profitLoss', 'Profit/Loss on Sale');
                    results.correctCount += plResults.correct;
                    results.incorrectCount += plResults.incorrect;
                    results.totalCount += plResults.total;
                    results.feedback.push(...plResults.feedback);
                    results.details.profitLoss = plResults;
                }

                return results;
            },

            // Validate a specific table
            validateTable(tableName, tableDisplayName) {
                const correctAnswers = AppState.correctAnswers[tableName];
                const results = {
                    correct: 0,
                    incorrect: 0,
                    total: 0,
                    feedback: []
                };

                for (const inputId in correctAnswers) {
                    const correctValue = correctAnswers[inputId];
                    const inputElement = document.getElementById(inputId);
                    
                    if (!inputElement) continue;

                    const userValue = parseFloat(inputElement.value) || 0;
                    const isCorrect = this.compareValues(userValue, correctValue);

                    results.total++;

                    // Get field description
                    const fieldDescription = this.getFieldDescription(inputId, tableDisplayName);

                    if (isCorrect) {
                        results.correct++;
                        this.markAsCorrect(inputElement);
                        results.feedback.push({
                            field: fieldDescription,
                            isCorrect: true,
                            message: 'Correct! Well done.',
                            userAnswer: userValue,
                            correctAnswer: correctValue
                        });
                    } else {
                        results.incorrect++;
                        this.markAsIncorrect(inputElement, correctValue);
                        results.feedback.push({
                            field: fieldDescription,
                            isCorrect: false,
                            message: this.getErrorMessage(inputId, userValue, correctValue),
                            userAnswer: userValue,
                            correctAnswer: correctValue
                        });
                    }
                }

                return results;
            },

            // Compare values with tolerance
            compareValues(userValue, correctValue) {
                return Math.abs(userValue - correctValue) <= this.tolerance;
            },

            // Mark input as correct
            markAsCorrect(inputElement) {
                inputElement.classList.remove('incorrect');
                inputElement.classList.add('correct');
                
                const parentCell = inputElement.parentElement;
                parentCell.classList.add('validated', 'correct');
                parentCell.classList.remove('incorrect');

                const validationIcon = parentCell.querySelector('.validation-icon');
                if (validationIcon) {
                    validationIcon.textContent = '✓';
                }

                // Add glow animation
                inputElement.classList.add('glow-success');
                setTimeout(() => inputElement.classList.remove('glow-success'), 1000);
            },

            // Mark input as incorrect
            markAsIncorrect(inputElement, correctValue) {
                inputElement.classList.remove('correct');
                inputElement.classList.add('incorrect');
                
                const parentCell = inputElement.parentElement;
                parentCell.classList.add('validated', 'incorrect');
                parentCell.classList.remove('correct');

                const validationIcon = parentCell.querySelector('.validation-icon');
                if (validationIcon) {
                    validationIcon.textContent = '✗';
                }

                // Show correct answer
                const correctDiv = document.getElementById(inputElement.id + '_correct');
                if (correctDiv) {
                    correctDiv.textContent = `Correct: ₹${correctValue.toLocaleString('en-IN')}`;
                    correctDiv.classList.add('show');
                }

                // Add shake animation
                inputElement.classList.add('shake');
                setTimeout(() => inputElement.classList.remove('shake'), 500);
            },

            // Get field description from input ID
            getFieldDescription(inputId, tableDisplayName) {
                const parts = inputId.split('_');
                let description = tableDisplayName + ' - ';

                if (inputId.includes('dr')) {
                    description += 'Debit Side';
                } else if (inputId.includes('cr')) {
                    description += 'Credit Side';
                }

                if (inputId.includes('total')) {
                    const yearIndex = parseInt(parts[parts.length - 1]) + 1;
                    description += ` (Year ${yearIndex} Total)`;
                } else if (inputId.includes('bookvalue')) {
                    description += ' (Book Value)';
                } else if (inputId.includes('sale')) {
                    description += ' (Sale Proceeds)';
                } else if (inputId.includes('profit')) {
                    description += ' (Profit)';
                } else if (inputId.includes('loss')) {
                    description += ' (Loss)';
                } else {
                    const yearIndex = parseInt(parts[2]) + 1;
                    const rowIndex = parseInt(parts[3]) + 1;
                    description += ` (Year ${yearIndex}, Entry ${rowIndex})`;
                }

                return description;
            },

            // Get error message based on the type of error
            getErrorMessage(inputId, userValue, correctValue) {
                if (userValue === 0) {
                    return 'You left this field empty. Make sure to enter all values.';
                }

                const difference = userValue - correctValue;
                const percentDiff = Math.abs(difference / correctValue * 100);

                if (percentDiff < 10) {
                    return 'Very close! Check your calculation for small errors.';
                } else if (percentDiff < 25) {
                    return 'Check your depreciation calculation or month adjustment.';
                } else if (percentDiff < 50) {
                    return 'Review the formula and verify your working.';
                } else {
                    return 'Significant difference. Review the concepts and try again.';
                }
            },

            // Calculate and update overall statistics
            updateStatistics(results) {
                AppState.stats.problemsAttempted++;
                AppState.stats.totalFields += results.totalCount;
                AppState.stats.correctFields += results.correctCount;

                // Update streak
                const percentCorrect = (results.correctCount / results.totalCount) * 100;
                if (percentCorrect >= 80) {
                    AppState.stats.currentStreak++;
                    if (AppState.stats.currentStreak > AppState.stats.bestStreak) {
                        AppState.stats.bestStreak = AppState.stats.currentStreak;
                    }
                } else {
                    AppState.stats.currentStreak = 0;
                }

                // Save to local storage
                StorageManager.saveStats();

                // Update UI
                UIRenderer.updateStats();
            }
        };

        // ========== HINT SYSTEM ==========
        const HintSystem = {
            // Current hint level (0 = no hint, 1 = basic, 2 = detailed, 3 = almost answer)
            currentHintLevel: 0,
            maxHintLevel: 3,

            // Reset hint level for new problem
            reset() {
                this.currentHintLevel = 0;
            },

            // Get next hint
            getNextHint() {
                if (this.currentHintLevel < this.maxHintLevel) {
                    this.currentHintLevel++;
                }
                return this.generateHint(this.currentHintLevel);
            },

            // Generate hint based on level
            generateHint(level) {
                const problem = AppState.currentProblem;
                if (!problem) return null;

                const hints = {
                    1: this.generateBasicHint(problem),
                    2: this.generateDetailedHint(problem),
                    3: this.generateAdvancedHint(problem)
                };

                return hints[level] || hints[1];
            },

            // Basic hint - formulas and concepts
            generateBasicHint(problem) {
                const totalCost = problem.purchasePrice + (problem.additionalCost || 0);
                
                return {
                    title: 'Basic Hint - Formulas',
                    sections: [
                        {
                            title: '📐 Straight Line Method Formula',
                            content: `
                                <div class="hint-formula">
                                    Annual Depreciation = Cost × Rate / 100
                                </div>
                                <p>Remember: Depreciation is charged on the <strong>original cost</strong>, not the book value.</p>
                            `
                        },
                        {
                            title: '💰 Total Cost Calculation',
                            content: `
                                <p>Total Cost = Purchase Price + Additional Expenses</p>
                                <p>In this problem, consider all expenses incurred to bring the asset to working condition.</p>
                            `
                        },
                        {
                            title: '📅 Partial Year Depreciation',
                            content: `
                                <p>If asset is not purchased on April 1st, calculate depreciation for the actual months:</p>
                                <div class="hint-formula">
                                    Partial Depreciation = Annual Depreciation × Months / 12
                                </div>
                            `
                        }
                    ]
                };
            },

            // Detailed hint - specific to problem
            generateDetailedHint(problem) {
                const totalCost = problem.purchasePrice + (problem.additionalCost || 0);
                const annualDep = Math.round(totalCost * problem.depreciationRate / 100);
                
                const firstYearMonths = DateUtils.calculateFirstYearMonths(
                    problem.purchaseDate.month,
                    problem.purchaseDate.day
                );

                let sections = [
                    {
                        title: '📊 Problem-Specific Values',
                        content: `
                            <p><strong>Total Cost of Asset:</strong></p>
                            <div class="hint-formula">
                                ₹${problem.purchasePrice.toLocaleString('en-IN')} ${problem.additionalCost ? `+ ₹${problem.additionalCost.toLocaleString('en-IN')}` : ''} = ₹${totalCost.toLocaleString('en-IN')}
                            </div>
                        `
                    },
                    {
                        title: '📈 Annual Depreciation',
                        content: `
                            <p><strong>At ${problem.depreciationRate}% per annum:</strong></p>
                            <div class="hint-formula">
                                ₹${totalCost.toLocaleString('en-IN')} × ${problem.depreciationRate}% = ₹${annualDep.toLocaleString('en-IN')}
                            </div>
                        `
                    }
                ];

                if (firstYearMonths < 12) {
                    const firstYearDep = Math.round(annualDep * firstYearMonths / 12);
                    sections.push({
                        title: '📅 First Year (Partial)',
                        content: `
                            <p>Asset purchased on ${DateUtils.formatDateShort(problem.purchaseDate.year, problem.purchaseDate.month, problem.purchaseDate.day)}</p>
                            <p>Depreciation period: <strong>${firstYearMonths} months</strong></p>
                            <div class="hint-formula">
                                ₹${annualDep.toLocaleString('en-IN')} × ${firstYearMonths}/12 = ₹${firstYearDep.toLocaleString('en-IN')}
                            </div>
                        `
                    });
                }

                if (problem.hasSale) {
                    sections.push({
                        title: '🏷️ Sale Calculation',
                        content: `
                            <p>When asset is sold:</p>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>Calculate depreciation up to sale date</li>
                                <li>Find Book Value = Cost - Total Depreciation</li>
                                <li>Compare with Sale Price to find Profit/Loss</li>
                            </ul>
                        `
                    });
                }

                return {
                    title: 'Detailed Hint - Working',
                    sections
                };
            },

            // Advanced hint - step by step approach
            generateAdvancedHint(problem) {
                const schedule = problem.schedule;
                const years = schedule.years;
                
                let yearByYearContent = '';
                years.forEach((year, index) => {
                    yearByYearContent += `
                        <div style="margin-bottom: 15px; padding: 10px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;">
                            <strong>Year ${index + 1} (${year.fyStartYear}-${year.fyEndYear}):</strong>
                            <ul style="margin-left: 20px; margin-top: 5px;">
                                <li>Opening: ₹${year.openingBalance.toLocaleString('en-IN')}</li>
                                <li>Depreciation: ${year.depreciationMonths} months = ?</li>
                                <li>Closing: Opening - Depreciation = ?</li>
                            </ul>
                        </div>
                    `;
                });

                return {
                    title: 'Advanced Hint - Step by Step',
                    sections: [
                        {
                            title: '📝 Year-by-Year Approach',
                            content: yearByYearContent
                        },
                        {
                            title: '✅ Verification Tips',
                            content: `
                                <ul style="margin-left: 20px;">
                                    <li>Debit Total must equal Credit Total for each year</li>
                                    <li>Closing Balance of Year N = Opening Balance of Year N+1</li>
                                    <li>For Asset A/c: Opening + Purchases = Depreciation + Closing/Sale</li>
                                </ul>
                            `
                        }
                    ]
                };
            },

            // Display hint in modal
            showHintModal() {
                const hint = this.getNextHint();
                if (!hint) return;

                const modal = document.getElementById('hintModal');
                const content = document.getElementById('hintContent');

                let html = '';
                hint.sections.forEach(section => {
                    html += `
                        <div class="hint-section">
                            <h4 class="hint-title">${section.title}</h4>
                            <div class="hint-text">${section.content}</div>
                        </div>
                    `;
                });

                // Add hint level indicator
                html += `
                    <div style="text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--card-border);">
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">
                            Hint Level: ${this.currentHintLevel}/${this.maxHintLevel}
                            ${this.currentHintLevel < this.maxHintLevel ? ' - Click again for more help' : ' - Maximum hints reached'}
                        </span>
                    </div>
                `;

                content.innerHTML = html;
                modal.classList.add('active');

                // Track hint usage
                UIRenderer.showToast('info', 'Hint Revealed', `Level ${this.currentHintLevel} hint shown`);
            }
        };

        // ========== SOLUTION DISPLAY ==========
        const SolutionDisplay = {
            // Show complete solution
            showSolution() {
                const problem = AppState.currentProblem;
                if (!problem) return;

                const modal = document.getElementById('solutionModal');
                const content = document.getElementById('solutionContent');

                const schedule = problem.schedule;
                const totalCost = problem.purchasePrice + (problem.additionalCost || 0);
                const annualDep = Math.round(totalCost * problem.depreciationRate / 100);

                let html = '';

                // Step 1: Calculate Total Cost
                html += `
                    <div class="solution-step">
                        <div class="solution-step-header">
                            <span class="solution-step-number">1</span>
                            <span class="solution-step-title">Calculate Total Cost of Asset</span>
                        </div>
                        <div class="solution-calculation">
                            <div class="calc-line">Purchase Price = ₹${problem.purchasePrice.toLocaleString('en-IN')}</div>
                            ${problem.additionalCost ? `<div class="calc-line">${problem.additionalCostDetails.name} = ₹${problem.additionalCost.toLocaleString('en-IN')}</div>` : ''}
                            <div class="calc-result">Total Cost = ₹${totalCost.toLocaleString('en-IN')}</div>
                        </div>
                    </div>
                `;

                // Step 2: Calculate Annual Depreciation
                html += `
                    <div class="solution-step">
                        <div class="solution-step-header">
                            <span class="solution-step-number">2</span>
                            <span class="solution-step-title">Calculate Annual Depreciation (SLM)</span>
                        </div>
                        <div class="solution-calculation">
                            <div class="calc-line">Depreciation Rate = ${problem.depreciationRate}% p.a.</div>
                            <div class="calc-line">Annual Depreciation = ₹${totalCost.toLocaleString('en-IN')} × ${problem.depreciationRate}/100</div>
                            <div class="calc-result">Annual Depreciation = ₹${annualDep.toLocaleString('en-IN')}</div>
                        </div>
                    </div>
                `;

                // Step 3: Year-wise Depreciation
                html += `
                    <div class="solution-step">
                        <div class="solution-step-header">
                            <span class="solution-step-number">3</span>
                            <span class="solution-step-title">Year-wise Depreciation Schedule</span>
                        </div>
                        <div class="solution-calculation">
                `;

                schedule.years.forEach((year, index) => {
                    html += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; ${index < schedule.years.length - 1 ? 'border-bottom: 1px dashed var(--card-border);' : ''}">
                            <strong>Year ${index + 1} (${year.fyStartYear}-${year.fyEndYear}):</strong>
                            <div class="calc-line" style="margin-top: 8px;">Opening Balance = ₹${year.openingBalance.toLocaleString('en-IN')}</div>
                            <div class="calc-line">Depreciation (${year.depreciationMonths} months) = ₹${year.depreciation.toLocaleString('en-IN')}</div>
                            <div class="calc-line">Accumulated Depreciation = ₹${year.accumulatedDepreciation.toLocaleString('en-IN')}</div>
                            <div class="calc-result">Closing Balance = ₹${year.closingBalance.toLocaleString('en-IN')}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;

                // Step 4: Sale calculation (if applicable)
                if (problem.hasSale && schedule.profitLossEntries) {
                    const pl = schedule.profitLossEntries;
                    html += `
                        <div class="solution-step">
                            <div class="solution-step-header">
                                <span class="solution-step-number">4</span>
                                <span class="solution-step-title">Profit/Loss on Sale Calculation</span>
                            </div>
                            <div class="solution-calculation">
                                <div class="calc-line">Book Value at Sale = ₹${pl.bookValueAtSale.toLocaleString('en-IN')}</div>
                                <div class="calc-line">Sale Price = ₹${pl.salePrice.toLocaleString('en-IN')}</div>
                                <div class="calc-line">Difference = ₹${pl.salePrice.toLocaleString('en-IN')} - ₹${pl.bookValueAtSale.toLocaleString('en-IN')}</div>
                                <div class="calc-result">
                                    ${pl.profitLoss.isProfit ? 'Profit' : pl.profitLoss.isLoss ? 'Loss' : 'No Profit/Loss'} 
                                    = ₹${pl.profitLoss.amount.toLocaleString('en-IN')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Step 5: Asset Account entries
                html += `
                    <div class="solution-step">
                        <div class="solution-step-header">
                            <span class="solution-step-number">${problem.hasSale ? '5' : '4'}</span>
                            <span class="solution-step-title">${problem.assetName} Account - Correct Entries</span>
                        </div>
                        ${this.generateAccountEntriesTable(schedule.assetAccountEntries, 'Asset')}
                    </div>
                `;

                // Step 6: Depreciation Account entries
                html += `
                    <div class="solution-step">
                        <div class="solution-step-header">
                            <span class="solution-step-number">${problem.hasSale ? '6' : '5'}</span>
                            <span class="solution-step-title">Depreciation Account - Correct Entries</span>
                        </div>
                        ${this.generateAccountEntriesTable(schedule.depreciationAccountEntries, 'Depreciation')}
                    </div>
                `;

                content.innerHTML = html;
                modal.classList.add('active');

                // Fill in all correct answers in the form
                this.fillAllCorrectAnswers();
            },

            // Generate table for account entries in solution
            generateAccountEntriesTable(entries, type) {
                let html = '<div style="overflow-x: auto;"><table class="t-account-table" style="margin-top: 15px; font-size: 0.85rem;">';
                html += `
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Particulars</th>
                            <th>Amount (₹)</th>
                            <th>Date</th>
                            <th>Particulars</th>
                            <th>Amount (₹)</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                entries.forEach((yearEntry, yearIndex) => {
                    const maxRows = Math.max(yearEntry.debitEntries.length, yearEntry.creditEntries.length);

                    for (let i = 0; i < maxRows; i++) {
                        const dr = yearEntry.debitEntries[i];
                        const cr = yearEntry.creditEntries[i];

                        html += '<tr>';
                        
                        // Debit side
                        if (dr) {
                            html += `
                                <td>${dr.date}</td>
                                <td>${dr.particulars}</td>
                                <td style="text-align: right; color: var(--success-color); font-weight: 600;">
                                    ${dr.amount.toLocaleString('en-IN')}
                                </td>
                            `;
                        } else {
                            html += '<td></td><td></td><td></td>';
                        }

                        // Credit side
                        if (cr) {
                            html += `
                                <td>${cr.date}</td>
                                <td>${cr.particulars}</td>
                                <td style="text-align: right; color: var(--success-color); font-weight: 600;">
                                    ${cr.amount.toLocaleString('en-IN')}
                                </td>
                            `;
                        } else {
                            html += '<td></td><td></td><td></td>';
                        }

                        html += '</tr>';
                    }

                    // Total row
                    html += `
                        <tr class="total-row">
                            <td></td>
                            <td><strong>Total</strong></td>
                            <td style="text-align: right; font-weight: 700; color: var(--success-color);">
                                ${yearEntry.debitTotal.toLocaleString('en-IN')}
                            </td>
                            <td></td>
                            <td><strong>Total</strong></td>
                            <td style="text-align: right; font-weight: 700; color: var(--success-color);">
                                ${yearEntry.creditTotal.toLocaleString('en-IN')}
                            </td>
                        </tr>
                    `;

                    // Year separator
                    if (yearIndex < entries.length - 1) {
                        html += '<tr class="year-separator"><td colspan="6"></td></tr>';
                    }
                });

                html += '</tbody></table></div>';
                return html;
            },

            // Fill all correct answers in input fields
            fillAllCorrectAnswers() {
                // Fill Asset Account answers
                if (AppState.correctAnswers.assetAccount) {
                    for (const inputId in AppState.correctAnswers.assetAccount) {
                        const input = document.getElementById(inputId);
                        if (input) {
                            input.value = AppState.correctAnswers.assetAccount[inputId];
                            input.classList.add('correct');
                            input.classList.remove('incorrect');
                        }
                    }
                }

                // Fill Depreciation Account answers
                if (AppState.correctAnswers.depreciationAccount) {
                    for (const inputId in AppState.correctAnswers.depreciationAccount) {
                        const input = document.getElementById(inputId);
                        if (input) {
                            input.value = AppState.correctAnswers.depreciationAccount[inputId];
                            input.classList.add('correct');
                            input.classList.remove('incorrect');
                        }
                    }
                }

                // Fill Profit/Loss answers
                if (AppState.correctAnswers.profitLoss) {
                    for (const inputId in AppState.correctAnswers.profitLoss) {
                        const input = document.getElementById(inputId);
                        if (input) {
                            input.value = AppState.correctAnswers.profitLoss[inputId];
                            input.classList.add('correct');
                            input.classList.remove('incorrect');
                        }
                    }
                }

                AppState.isSolutionShown = true;
            }
        };

        // ========== TIMER MANAGER ==========
        const TimerManager = {
            // Start timer
            start() {
                if (AppState.isTimerRunning) return;

                AppState.isTimerRunning = true;
                AppState.timerSeconds = 0;
                
                const timerDisplay = document.getElementById('timerDisplay');
                timerDisplay.classList.add('running');

                AppState.timerInterval = setInterval(() => {
                    AppState.timerSeconds++;
                    this.updateDisplay();
                }, 1000);
            },

            // Stop timer
            stop() {
                AppState.isTimerRunning = false;
                
                const timerDisplay = document.getElementById('timerDisplay');
                timerDisplay.classList.remove('running');

                if (AppState.timerInterval) {
                    clearInterval(AppState.timerInterval);
                    AppState.timerInterval = null;
                }
            },

            // Reset timer
            reset() {
                this.stop();
                AppState.timerSeconds = 0;
                this.updateDisplay();
            },

            // Update display
            updateDisplay() {
                const minutes = Math.floor(AppState.timerSeconds / 60);
                const seconds = AppState.timerSeconds % 60;
                
                const timerValue = document.getElementById('timerValue');
                timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            },

            // Get formatted time
            getFormattedTime() {
                const minutes = Math.floor(AppState.timerSeconds / 60);
                const seconds = AppState.timerSeconds % 60;
                
                if (minutes > 0) {
                    return `${minutes} min ${seconds} sec`;
                }
                return `${seconds} seconds`;
            }
        };

        // ========== STORAGE MANAGER ==========
        const StorageManager = {
            // Storage keys
            KEYS: {
                STATS: 'depreciation_practice_stats',
                SETTINGS: 'depreciation_practice_settings',
                HISTORY: 'depreciation_practice_history'
            },

            // Save statistics
            saveStats() {
                try {
                    localStorage.setItem(this.KEYS.STATS, JSON.stringify(AppState.stats));
                } catch (e) {
                    console.warn('Could not save stats to localStorage:', e);
                }
            },

            // Load statistics
            loadStats() {
                try {
                    const saved = localStorage.getItem(this.KEYS.STATS);
                    if (saved) {
                        const stats = JSON.parse(saved);
                        Object.assign(AppState.stats, stats);
                    }
                } catch (e) {
                    console.warn('Could not load stats from localStorage:', e);
                }
            },

            // Save settings
            saveSettings(settings) {
                try {
                    localStorage.setItem(this.KEYS.SETTINGS, JSON.stringify(settings));
                } catch (e) {
                    console.warn('Could not save settings:', e);
                }
            },

            // Load settings
            loadSettings() {
                try {
                    const saved = localStorage.getItem(this.KEYS.SETTINGS);
                    return saved ? JSON.parse(saved) : null;
                } catch (e) {
                    console.warn('Could not load settings:', e);
                    return null;
                }
            },

            // Save problem to history
            saveProblemToHistory(problem, results) {
                try {
                    let history = this.getHistory();
                    history.unshift({
                        id: problem.id,
                        date: new Date().toISOString(),
                        difficulty: problem.difficulty,
                        assetName: problem.assetName,
                        score: Math.round((results.correctCount / results.totalCount) * 100),
                        time: TimerManager.getFormattedTime(),
                        correct: results.correctCount,
                        total: results.totalCount
                    });

                    // Keep only last 50 problems
                    if (history.length > 50) {
                        history = history.slice(0, 50);
                    }

                    localStorage.setItem(this.KEYS.HISTORY, JSON.stringify(history));
                } catch (e) {
                    console.warn('Could not save to history:', e);
                }
            },

            // Get history
            getHistory() {
                try {
                    const saved = localStorage.getItem(this.KEYS.HISTORY);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    return [];
                }
            },

            // Clear all data
            clearAll() {
                try {
                    localStorage.removeItem(this.KEYS.STATS);
                    localStorage.removeItem(this.KEYS.SETTINGS);
                    localStorage.removeItem(this.KEYS.HISTORY);
                } catch (e) {
                    console.warn('Could not clear storage:', e);
                }
            }
        };

        // ========== PRINT & EXPORT MANAGER ==========
        const ExportManager = {
            // Print current problem
            printProblem() {
                window.print();
            },

            // Export results as image (using canvas)
            async exportAsImage() {
                UIRenderer.showToast('info', 'Export', 'Preparing image export...');
                
                // Create a simple text-based export
                const problem = AppState.currentProblem;
                if (!problem) {
                    UIRenderer.showToast('error', 'Error', 'No problem to export');
                    return;
                }

                // For now, trigger print which can be saved as PDF
                this.printProblem();
            },

            // Generate text summary
            generateTextSummary(problem, results) {
                const schedule = problem.schedule;
                let text = '=== DEPRECIATION PRACTICE RESULT ===\n\n';
                
                text += `Asset: ${problem.assetName}\n`;
                text += `Purchase Price: ₹${problem.purchasePrice.toLocaleString('en-IN')}\n`;
                text += `Depreciation Rate: ${problem.depreciationRate}%\n`;
                text += `Method: Straight Line Method\n\n`;
                
                text += `Score: ${results.correctCount}/${results.totalCount} (${Math.round((results.correctCount/results.totalCount)*100)}%)\n`;
                text += `Time Taken: ${TimerManager.getFormattedTime()}\n\n`;
                
                text += '--- Correct Answers ---\n';
                schedule.years.forEach((year, i) => {
                    text += `Year ${i+1}: Depreciation ₹${year.depreciation.toLocaleString('en-IN')}, Closing ₹${year.closingBalance.toLocaleString('en-IN')}\n`;
                });

                return text;
            },

            // Copy results to clipboard
            copyToClipboard(problem, results) {
                const text = this.generateTextSummary(problem, results);
                
                navigator.clipboard.writeText(text).then(() => {
                    UIRenderer.showToast('success', 'Copied!', 'Results copied to clipboard');
                }).catch(err => {
                    UIRenderer.showToast('error', 'Error', 'Could not copy to clipboard');
                });
            }
        };

        // ========== KEYBOARD SHORTCUTS ==========
        const KeyboardShortcuts = {
            init() {
                document.addEventListener('keydown', (e) => {
                    // Skip if user is typing in input
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }

                    // Ctrl/Cmd + N: New Problem
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        App.generateNewProblem();
                    }

                    // Ctrl/Cmd + Enter: Check Answers
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        e.preventDefault();
                        App.checkAnswers();
                    }

                    // Ctrl/Cmd + H: Show Hint
                    if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                        e.preventDefault();
                        App.showHint();
                    }

                    // Ctrl/Cmd + S: Show Solution
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        App.showSolution();
                    }

                    // Ctrl/Cmd + R: Reset
                    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                        e.preventDefault();
                        App.resetCurrentProblem();
                    }

                    // Escape: Close modals
                    if (e.key === 'Escape') {
                        App.closeAllModals();
                    }
                });
            }
        };

        // Console log for testing
        console.log('Part 5 Loaded: Answer Checking, Validation, Hints, Timer & Solution');
        console.log('Available modules: AnswerValidator, HintSystem, SolutionDisplay, TimerManager, StorageManager, ExportManager, KeyboardShortcuts');
        
        /* ========================================================
           DEPRECIATION PRACTICE APPLICATION
           Part 6: Main App Controller & Final Integration
           ======================================================== */

        // ========== MAIN APP CONTROLLER ==========
        const App = {
            // Initialize the application
            init() {
                console.log('🚀 Initializing Depreciation Practice App...');

                // Load saved data
                StorageManager.loadStats();

                // Initialize UI components
                UIRenderer.initParticles();
                UIRenderer.updateStats();
                UIRenderer.renderEmptyState();

                // Initialize input handlers
                InputHandler.init();

                // Initialize keyboard shortcuts
                KeyboardShortcuts.init();

                // Initialize modal handlers
                this.initModalHandlers();

                // Initialize button event listeners
                this.initButtonListeners();

                // Initialize select change listeners
                this.initSelectListeners();

                // Load settings if any
                this.loadSettings();

                console.log('✅ App initialized successfully!');
                UIRenderer.showToast('success', 'Welcome!', 'Ready to practice depreciation accounting');
            },

            // Initialize modal handlers
            initModalHandlers() {
                // Hint modal close
                const hintModal = document.getElementById('hintModal');
                const closeHintModal = document.getElementById('closeHintModal');
                
                if (closeHintModal) {
                    closeHintModal.addEventListener('click', () => {
                        hintModal.classList.remove('active');
                    });
                }

                // Solution modal close
                const solutionModal = document.getElementById('solutionModal');
                const closeSolutionModal = document.getElementById('closeSolutionModal');
                
                if (closeSolutionModal) {
                    closeSolutionModal.addEventListener('click', () => {
                        solutionModal.classList.remove('active');
                    });
                }

                // Close modals when clicking outside
                [hintModal, solutionModal].forEach(modal => {
                    if (modal) {
                        modal.addEventListener('click', (e) => {
                            if (e.target === modal) {
                                modal.classList.remove('active');
                            }
                        });
                    }
                });
            },

            // Initialize button event listeners
            initButtonListeners() {
                // New Problem button
                const newProblemBtn = document.getElementById('newProblemBtn');
                if (newProblemBtn) {
                    newProblemBtn.addEventListener('click', () => this.generateNewProblem());
                }

                // Check Answers button
                const checkAnswersBtn = document.getElementById('checkAnswersBtn');
                if (checkAnswersBtn) {
                    checkAnswersBtn.addEventListener('click', () => this.checkAnswers());
                }

                // Show Solution button
                const showSolutionBtn = document.getElementById('showSolutionBtn');
                if (showSolutionBtn) {
                    showSolutionBtn.addEventListener('click', () => this.showSolution());
                }

                // Reset button
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => this.resetCurrentProblem());
                }

                // Hint button
                const hintBtn = document.getElementById('hintBtn');
                if (hintBtn) {
                    hintBtn.addEventListener('click', () => this.showHint());
                }
            },

            // Initialize select change listeners
            initSelectListeners() {
                // Difficulty select
                const difficultySelect = document.getElementById('difficulty');
                if (difficultySelect) {
                    difficultySelect.addEventListener('change', (e) => {
                        this.saveSettings();
                        UIRenderer.showToast('info', 'Difficulty Changed', 
                            `Set to ${e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1)}`);
                    });
                }

                // Mode select
                const modeSelect = document.getElementById('mode');
                if (modeSelect) {
                    modeSelect.addEventListener('change', (e) => {
                        this.saveSettings();
                        const mode = e.target.value;
                        if (mode === 'exam') {
                            UIRenderer.showToast('warning', 'Exam Mode', 
                                'Hints will be limited. Timer will be strict.');
                        } else {
                            UIRenderer.showToast('info', 'Practice Mode', 
                                'Learn at your own pace with hints available.');
                        }
                    });
                }
            },

            // Generate new problem
            generateNewProblem() {
                console.log('📝 Generating new problem...');

                // Get current difficulty
                const difficulty = document.getElementById('difficulty').value;

                // Reset state
                this.resetState();

                // Remove empty state if present
                UIRenderer.removeEmptyState();

                // Generate problem
                const problem = ProblemGenerator.generateProblem(difficulty);
                AppState.currentProblem = problem;

                console.log('Generated problem:', problem);

                // Render UI
                UIRenderer.renderProblemCard(problem);
                UIRenderer.renderAssetAccountTable(problem);
                UIRenderer.renderDepreciationAccountTable(problem);
                UIRenderer.renderProfitLossSection(problem);

                // Hide results section
                document.getElementById('resultsSection').style.display = 'none';

                // Enable buttons
                document.getElementById('checkAnswersBtn').disabled = true; // Will enable when user enters data
                document.getElementById('showSolutionBtn').disabled = false;
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('hintBtn').disabled = false;

                // Start timer
                TimerManager.reset();
                TimerManager.start();

                // Reset hint system
                HintSystem.reset();

                // Show toast
                UIRenderer.showToast('success', 'New Problem Generated!', 
                    `${problem.assetName} - ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} difficulty`);

                // Scroll to problem card
                document.getElementById('problemCard').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });

                // Focus first input
                setTimeout(() => {
                    const firstInput = document.querySelector('.table-input');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 800);
            },

            // Check all answers
            checkAnswers() {
                if (!AppState.currentProblem) {
                    UIRenderer.showToast('error', 'Error', 'No problem to check. Generate a problem first.');
                    return;
                }

                if (AppState.isChecked) {
                    UIRenderer.showToast('warning', 'Already Checked', 
                        'Answers have already been checked. Generate a new problem or reset.');
                    return;
                }

                console.log('✓ Checking answers...');

                // Stop timer
                TimerManager.stop();

                // Validate all answers
                const results = AnswerValidator.validateAllAnswers();
                
                console.log('Validation results:', results);

                // Mark as checked
                AppState.isChecked = true;

                // Update statistics
                AnswerValidator.updateStatistics(results);

                // Save to history
                StorageManager.saveProblemToHistory(AppState.currentProblem, results);

                // Render results
                UIRenderer.renderResults(results);

                // Scroll to results
                setTimeout(() => {
                    document.getElementById('resultsSection').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);

                // Show appropriate toast
                const percentage = Math.round((results.correctCount / results.totalCount) * 100);
                if (percentage >= 90) {
                    UIRenderer.showToast('success', 'Excellent! 🏆', 
                        `You scored ${percentage}% in ${TimerManager.getFormattedTime()}`);
                } else if (percentage >= 70) {
                    UIRenderer.showToast('success', 'Good Job! 👍', 
                        `You scored ${percentage}%. Keep practicing!`);
                } else if (percentage >= 50) {
                    UIRenderer.showToast('warning', 'Keep Trying! 📚', 
                        `You scored ${percentage}%. Review the concepts.`);
                } else {
                    UIRenderer.showToast('error', 'Needs Improvement 💪', 
                        `You scored ${percentage}%. Check the solution to learn.`);
                }

                // Disable check button, enable others
                document.getElementById('checkAnswersBtn').disabled = true;
            },

            // Show hint
            showHint() {
                if (!AppState.currentProblem) {
                    UIRenderer.showToast('error', 'Error', 'Generate a problem first to get hints.');
                    return;
                }

                // Check mode - limit hints in exam mode
                const mode = document.getElementById('mode').value;
                if (mode === 'exam' && HintSystem.currentHintLevel >= 1) {
                    UIRenderer.showToast('warning', 'Exam Mode', 
                        'Only 1 hint allowed in exam mode.');
                    return;
                }

                HintSystem.showHintModal();
            },

            // Show solution
            showSolution() {
                if (!AppState.currentProblem) {
                    UIRenderer.showToast('error', 'Error', 'Generate a problem first.');
                    return;
                }

                // Confirm if not yet checked
                if (!AppState.isChecked) {
                    const confirm = window.confirm(
                        'You haven\'t checked your answers yet. Viewing the solution will reveal all answers. Continue?'
                    );
                    if (!confirm) return;

                    // Stop timer if running
                    TimerManager.stop();
                }

                SolutionDisplay.showSolution();
                UIRenderer.showToast('info', 'Solution Shown', 
                    'Study the step-by-step solution carefully.');
            },

            // Reset current problem
            resetCurrentProblem() {
                if (!AppState.currentProblem) {
                    UIRenderer.showToast('error', 'Error', 'No problem to reset.');
                    return;
                }

                const confirm = window.confirm(
                    'This will clear all your answers. Are you sure?'
                );
                if (!confirm) return;

                // Clear all inputs
                InputHandler.clearAllInputs();

                // Reset state flags
                AppState.isChecked = false;
                AppState.isSolutionShown = false;
                AppState.userAnswers = {};

                // Reset hint system
                HintSystem.reset();

                // Reset timer
                TimerManager.reset();
                TimerManager.start();

                // Reset buttons
                document.getElementById('checkAnswersBtn').disabled = true;
                document.getElementById('showSolutionBtn').disabled = false;
                document.getElementById('hintBtn').disabled = false;

                // Hide results
                document.getElementById('resultsSection').style.display = 'none';

                UIRenderer.showToast('info', 'Reset Complete', 
                    'All answers cleared. Timer restarted.');

                // Focus first input
                const firstInput = document.querySelector('.table-input');
                if (firstInput) {
                    firstInput.focus();
                }
            },

            // Reset state for new problem
            resetState() {
                AppState.currentProblem = null;
                AppState.correctAnswers = {};
                AppState.userAnswers = {};
                AppState.isChecked = false;
                AppState.isSolutionShown = false;
            },

            // Close all modals
            closeAllModals() {
                document.getElementById('hintModal').classList.remove('active');
                document.getElementById('solutionModal').classList.remove('active');
            },

            // Save settings
            saveSettings() {
                const settings = {
                    difficulty: document.getElementById('difficulty').value,
                    mode: document.getElementById('mode').value
                };
                StorageManager.saveSettings(settings);
            },

            // Load settings
            loadSettings() {
                const settings = StorageManager.loadSettings();
                if (settings) {
                    if (settings.difficulty) {
                        document.getElementById('difficulty').value = settings.difficulty;
                    }
                    if (settings.mode) {
                        document.getElementById('mode').value = settings.mode;
                    }
                }
            },

            // Export functionality
            exportResults() {
                if (!AppState.currentProblem) {
                    UIRenderer.showToast('error', 'Error', 'No results to export.');
                    return;
                }
                ExportManager.printProblem();
            },

            // Copy results
            copyResults() {
                if (!AppState.currentProblem || !AppState.isChecked) {
                    UIRenderer.showToast('error', 'Error', 'Check answers first before copying results.');
                    return;
                }

                const results = AnswerValidator.validateAllAnswers();
                ExportManager.copyToClipboard(AppState.currentProblem, results);
            },

            // Get current stats
            getStats() {
                return AppState.stats;
            },

            // Get practice history
            getHistory() {
                return StorageManager.getHistory();
            },

            // Clear all data (for testing/reset)
            clearAllData() {
                const confirm = window.confirm(
                    'This will clear all your practice history and statistics. This cannot be undone. Continue?'
                );
                if (!confirm) return;

                StorageManager.clearAll();
                
                // Reset stats
                AppState.stats = {
                    problemsAttempted: 0,
                    correctAnswers: 0,
                    totalFields: 0,
                    correctFields: 0,
                    currentStreak: 0,
                    bestStreak: 0
                };

                UIRenderer.updateStats();
                UIRenderer.showToast('success', 'Data Cleared', 
                    'All practice history and statistics have been reset.');
            }
        };

        // ========== ADDITIONAL UTILITY FUNCTIONS ==========
        
        // Format number with Indian numbering system
        function formatIndianNumber(num) {
            const str = num.toString();
            let result = '';
            let count = 0;
            
            for (let i = str.length - 1; i >= 0; i--) {
                count++;
                result = str[i] + result;
                
                if (count === 3 && i !== 0) {
                    result = ',' + result;
                } else if (count > 3 && (count - 3) % 2 === 0 && i !== 0) {
                    result = ',' + result;
                }
            }
            
            return result;
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function for scroll events
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ========== SCROLL ANIMATIONS ==========
        const ScrollAnimations = {
            init() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.classList.add('visible');
                        }
                    });
                }, {
                    threshold: 0.1,
                    rootMargin: '0px 0px -50px 0px'
                });

                // Observe all animatable elements
                document.querySelectorAll('.animate-on-scroll').forEach(el => {
                    observer.observe(el);
                });
            }
        };

        // ========== ACCESSIBILITY IMPROVEMENTS ==========
        const Accessibility = {
            init() {
                // Add ARIA labels to inputs
                document.querySelectorAll('.table-input').forEach(input => {
                    const table = input.dataset.table;
                    const side = input.dataset.side;
                    const year = input.dataset.year;
                    
                    input.setAttribute('aria-label', 
                        `${table} ${side} side year ${parseInt(year) + 1} amount`);
                });

                // Announce results to screen readers
                this.setupLiveRegion();
            },

            setupLiveRegion() {
                const liveRegion = document.createElement('div');
                liveRegion.setAttribute('aria-live', 'polite');
                liveRegion.setAttribute('aria-atomic', 'true');
                liveRegion.className = 'sr-only';
                liveRegion.id = 'aria-live-region';
                document.body.appendChild(liveRegion);
            },

            announce(message) {
                const liveRegion = document.getElementById('aria-live-region');
                if (liveRegion) {
                    liveRegion.textContent = message;
                }
            }
        };

        // ========== PERFORMANCE MONITORING ==========
        const Performance = {
            marks: {},

            start(label) {
                this.marks[label] = performance.now();
            },

            end(label) {
                if (this.marks[label]) {
                    const duration = performance.now() - this.marks[label];
                    console.log(`⏱️ ${label}: ${duration.toFixed(2)}ms`);
                    delete this.marks[label];
                    return duration;
                }
                return 0;
            }
        };

        // ========== ERROR HANDLER ==========
        const ErrorHandler = {
            init() {
                window.addEventListener('error', (e) => {
                    console.error('Application Error:', e.error);
                    UIRenderer.showToast('error', 'Error', 
                        'An error occurred. Please refresh the page.');
                });

                window.addEventListener('unhandledrejection', (e) => {
                    console.error('Unhandled Promise Rejection:', e.reason);
                });
            }
        };

        // ========== SERVICE WORKER REGISTRATION (Optional - for PWA) ==========
        const ServiceWorkerManager = {
            async register() {
                if ('serviceWorker' in navigator) {
                    try {
                        // For now, just log that SW is available
                        console.log('Service Worker support detected');
                    } catch (error) {
                        console.log('Service Worker registration skipped');
                    }
                }
            }
        };

        // ========== ONLINE/OFFLINE DETECTION ==========
        const ConnectionStatus = {
            init() {
                window.addEventListener('online', () => {
                    UIRenderer.showToast('success', 'Back Online', 
                        'Your internet connection has been restored.');
                });

                window.addEventListener('offline', () => {
                    UIRenderer.showToast('warning', 'Offline', 
                        'You are offline. Your progress will be saved locally.');
                });
            }
        };

        // ========== HELP SYSTEM ==========
        const HelpSystem = {
            shortcuts: [
                { keys: ['Ctrl', 'N'], description: 'Generate new problem' },
                { keys: ['Ctrl', 'Enter'], description: 'Check answers' },
                { keys: ['Ctrl', 'H'], description: 'Show hint' },
                { keys: ['Ctrl', 'S'], description: 'Show solution' },
                { keys: ['Ctrl', 'R'], description: 'Reset problem' },
                { keys: ['Esc'], description: 'Close modals' },
                { keys: ['Tab'], description: 'Move to next input' },
                { keys: ['Enter'], description: 'Move to next input' }
            ],

            showShortcutsHelp() {
                let html = '<div style="padding: 20px;">';
                html += '<h3 style="margin-bottom: 20px;">⌨️ Keyboard Shortcuts</h3>';
                html += '<div style="display: grid; gap: 10px;">';
                
                this.shortcuts.forEach(shortcut => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--input-bg); border-radius: 8px;">
                            <span>${shortcut.description}</span>
                            <span>
                                ${shortcut.keys.map(key => 
                                    `<span class="shortcut-key">${key}</span>`
                                ).join(' + ')}
                            </span>
                        </div>
                    `;
                });

                html += '</div></div>';

                // Show in solution modal (reuse)
                const modal = document.getElementById('solutionModal');
                const content = document.getElementById('solutionContent');
                content.innerHTML = html;
                modal.classList.add('active');
            }
        };

        // ========== THEME MANAGER (Future Enhancement) ==========
        const ThemeManager = {
            currentTheme: 'dark',

            setTheme(theme) {
                this.currentTheme = theme;
                document.body.setAttribute('data-theme', theme);
                StorageManager.saveSettings({ ...StorageManager.loadSettings(), theme });
            },

            toggleTheme() {
                this.setTheme(this.currentTheme === 'dark' ? 'light' : 'dark');
            }
        };

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', () => {
            Performance.start('App Initialization');

            // Initialize error handler first
            ErrorHandler.init();

            // Initialize main app
            App.init();

            // Initialize additional systems
            ConnectionStatus.init();
            Accessibility.init();
            ScrollAnimations.init();

            // Optional: Register service worker
            ServiceWorkerManager.register();

            Performance.end('App Initialization');

            // Log available global functions for console usage
            console.log('');
            console.log('🎓 DEPRECIATION PRACTICE APP - Console Commands:');
            console.log('================================================');
            console.log('App.generateNewProblem() - Generate a new problem');
            console.log('App.checkAnswers() - Check current answers');
            console.log('App.showHint() - Show a hint');
            console.log('App.showSolution() - Show complete solution');
            console.log('App.resetCurrentProblem() - Reset current problem');
            console.log('App.getStats() - View your statistics');
            console.log('App.getHistory() - View practice history');
            console.log('App.clearAllData() - Clear all saved data');
            console.log('HelpSystem.showShortcutsHelp() - Show keyboard shortcuts');
            console.log('');
        });

        // ========== EXPOSE APP TO WINDOW FOR DEBUGGING ==========
        window.DepreciationApp = {
            App,
            AppState,
            ProblemGenerator,
            CalculationEngine,
            UIRenderer,
            AnswerValidator,
            HintSystem,
            SolutionDisplay,
            TimerManager,
            StorageManager,
            HelpSystem
        };

        // ========== FINAL CONSOLE MESSAGE ==========
        console.log('');
        console.log('%c📊 Depreciation Practice Application', 
            'font-size: 20px; font-weight: bold; color: #667eea;');
        console.log('%cFor Grade 11 Students - DK Goyal Pattern', 
            'font-size: 14px; color: #764ba2;');
        console.log('%cStraight Line Method (SLM) Only', 
            'font-size: 12px; color: #888;');
        console.log('');
        console.log('Part 6 Loaded: Main App Controller & Final Integration');
        console.log('✅ All 6 parts loaded successfully!');
        console.log('🎉 Application is ready to use!');
    </script>
</body>
</html>